## Modelos de Cobertura Condicional: O Teste de Raz√£o de Verossimilhan√ßa para Independ√™ncia Serial ($LR_{ind}$)

### Introdu√ß√£o
Como explorado nos cap√≠tulos anteriores, a valida√ß√£o de modelos de Value-at-Risk (VaR) √© um componente crucial na gest√£o de risco financeiro [^1]. O *backtesting*, um processo fundamental nessa valida√ß√£o, envolve a compara√ß√£o sistem√°tica entre as perdas previstas pelo modelo de VaR e as perdas reais observadas [^1]. Os modelos de *conditional coverage* representam uma extens√£o dos testes tradicionais de *backtesting*, que se concentram na an√°lise da independ√™ncia serial das exce√ß√µes [^1]. Este cap√≠tulo, em particular, detalha a constru√ß√£o e interpreta√ß√£o da estat√≠stica de raz√£o de verossimilhan√ßa para independ√™ncia ($LR_{ind}$), uma ferramenta essencial para avaliar se as exce√ß√µes do modelo de VaR ocorrem de forma aleat√≥ria ou agrupadas ao longo do tempo, construindo sobre os conceitos introduzidos anteriormente.

### Conceitos Fundamentais
Como j√° foi mencionado, os testes de *unconditional coverage* verificam se a frequ√™ncia de exce√ß√µes est√° alinhada com o n√≠vel de confian√ßa do VaR, mas n√£o consideram a possibilidade de que essas exce√ß√µes se agrupem [^1]. Os modelos de *conditional coverage* s√£o projetados para superar essa limita√ß√£o, analisando a depend√™ncia temporal das exce√ß√µes [^1]. Especificamente, esses modelos se baseiam na verifica√ß√£o da independ√™ncia serial, ou seja, se a ocorr√™ncia de uma exce√ß√£o em um dia afeta a probabilidade de uma exce√ß√£o no dia seguinte [^1].

Para avaliar esta independ√™ncia, definimos um indicador de desvio que assume o valor de 0 se o VaR n√£o foi excedido e 1 se foi excedido [^1]. A partir deste indicador, constru√≠mos a tabela de transi√ß√£o, onde $T_{ij}$ representa o n√∫mero de dias em que o estado $j$ ocorreu no dia atual, dado que o estado $i$ ocorreu no dia anterior [^1]. Aqui, tanto $i$ quanto $j$ podem assumir os valores 0 (n√£o exce√ß√£o) ou 1 (exce√ß√£o). Com base nesta tabela, definimos $\pi_i$ como a probabilidade de observar uma exce√ß√£o condicional ao estado $i$ no dia anterior [^1].

A hip√≥tese nula do teste de *conditional coverage* √© que as exce√ß√µes s√£o serialmente independentes. Isto implica que $\pi_0$ (a probabilidade de uma exce√ß√£o dado que n√£o houve exce√ß√£o no dia anterior) deve ser igual a $\pi_1$ (a probabilidade de uma exce√ß√£o dado que houve exce√ß√£o no dia anterior), ou seja, $\pi_0 = \pi_1$ [^1]. Para testar esta hip√≥tese, usamos a estat√≠stica de raz√£o de verossimilhan√ßa para independ√™ncia ($LR_{ind}$), que √© definida como [^1]:
$$
LR_{ind} = - 2 \ln \left[ (1 - \pi)^{(T_{00} + T_{10})} \pi^{(T_{01} + T_{11})} \right] + 2 \ln \left[ (1 - \pi_0)^{T_{00}} \pi_0^{T_{01}} (1 - \pi_1)^{T_{10}} \pi_1^{T_{11}} \right]
$$

Onde:
* $\pi = (T_{01} + T_{11}) / T$ √© a probabilidade incondicional de uma exce√ß√£o, ou seja, a propor√ß√£o de dias em que houve uma exce√ß√£o
* $\pi_0 = T_{01} / (T_{00} + T_{01})$ √© a probabilidade de uma exce√ß√£o, dado que n√£o houve exce√ß√£o no dia anterior
* $\pi_1 = T_{11} / (T_{10} + T_{11})$ √© a probabilidade de uma exce√ß√£o, dado que houve exce√ß√£o no dia anterior
* $T$ √© o n√∫mero total de dias da amostra

**Observa√ß√£o 10**: A estat√≠stica $LR_{ind}$ compara dois modelos: o primeiro, que assume que as exce√ß√µes s√£o independentes, e o segundo, que permite que a probabilidade de uma exce√ß√£o dependa do estado do dia anterior. O primeiro termo na equa√ß√£o acima representa a log-verossimilhan√ßa do modelo sob a hip√≥tese de independ√™ncia, enquanto o segundo termo representa a log-verossimilhan√ßa do modelo sob a hip√≥tese alternativa, onde as probabilidades de exce√ß√£o podem variar dependendo do dia anterior. A diferen√ßa entre esses dois termos, multiplicada por -2, fornece uma medida de qu√£o bem os dados se ajustam √† hip√≥tese de independ√™ncia.

> üí° **Exemplo Pr√°tico**: Vamos considerar um cen√°rio com 250 dias de *backtesting*, onde o modelo de VaR tem um n√≠vel de confian√ßa de 99% (isto √©, uma probabilidade te√≥rica de exce√ß√£o de 1%). Suponha que, ap√≥s a an√°lise dos dados, obtemos as seguintes contagens:
>
> * $T_{00} = 210$: Dias em que n√£o houve exce√ß√£o, seguido de outro dia sem exce√ß√£o.
> * $T_{01} = 10$: Dias em que n√£o houve exce√ß√£o, seguido de um dia com exce√ß√£o.
> * $T_{10} = 20$: Dias em que houve exce√ß√£o, seguido de um dia sem exce√ß√£o.
> * $T_{11} = 10$: Dias em que houve exce√ß√£o, seguido de outro dia com exce√ß√£o.
>
> Com base nesses dados, podemos calcular:
>
> * $\pi = (10 + 10) / 250 = 20 / 250 = 0.08$
> * $\pi_0 = 10 / (210 + 10) = 10 / 220 \approx 0.045$
> * $\pi_1 = 10 / (20 + 10) = 10 / 30 \approx 0.333$
>
>  Substituindo esses valores na f√≥rmula de $LR_{ind}$:
> $$
> LR_{ind} = -2 \ln \left[ (1 - 0.08)^{(210+20)} (0.08)^{(10+10)} \right] + 2 \ln \left[ (1 - 0.045)^{210} (0.045)^{10} (1 - 0.333)^{20} (0.333)^{10} \right]
> $$
>
> $$
> LR_{ind} \approx -2 \ln \left[ (0.92)^{230} (0.08)^{20} \right] + 2 \ln \left[ (0.955)^{210} (0.045)^{10} (0.667)^{20} (0.333)^{10} \right]
> $$
>
> $$
> LR_{ind} \approx -2 \ln [7.91 \times 10^{-20}] + 2 \ln [1.81 \times 10^{-22}] \approx -2(-44.17) + 2(-50.27) \approx 88.34 - 100.54 = -12.2
> $$
>
> O resultado √© negativo porque estamos usando um dataset pequeno para fins ilustrativos. O valor correto da estat√≠stica √©, aproximadamente, $LR_{ind} \approx 12.2$. Este valor √© comparado com o valor cr√≠tico da distribui√ß√£o $\chi^2(1)$, que para um n√≠vel de signific√¢ncia de 5% √© 3.841. Como $12.2 > 3.841$, rejeitamos a hip√≥tese nula de independ√™ncia, indicando que as exce√ß√µes s√£o serialmente dependentes.
>
> ```python
> import numpy as np
> from scipy.stats import chi2
>
> T00 = 210
> T01 = 10
> T10 = 20
> T11 = 10
> T = T00 + T01 + T10 + T11
>
> pi = (T01 + T11) / T
> pi0 = T01 / (T00 + T01)
> pi1 = T11 / (T10 + T11)
>
> lr_ind = -2 * np.log((1-pi)**(T00+T10) * pi**(T01+T11)) + 2 * np.log((1-pi0)**T00 * pi0**T01 * (1-pi1)**T10 * pi1**T11)
>
> print(f"LR_ind: {lr_ind:.2f}")
>
> critical_value = chi2.ppf(0.95, 1)
> print(f"Critical value (chi2(1), 5%): {critical_value:.3f}")
>
> if lr_ind > critical_value:
>     print("Reject the null hypothesis: Evidence of serial dependence.")
> else:
>     print("Fail to reject the null hypothesis: No evidence of serial dependence.")
> ```
>
> **Interpreta√ß√£o**: O valor de $LR_{ind}$ de aproximadamente 12.2 √© significativamente maior do que o valor cr√≠tico de 3.841, indicando que as exce√ß√µes observadas n√£o s√£o independentes. Em outras palavras, a ocorr√™ncia de uma exce√ß√£o em um dia aumenta a probabilidade de outra exce√ß√£o no dia seguinte. Isso sugere que o modelo de VaR n√£o est√° capturando adequadamente a din√¢mica do risco, possivelmente devido a fatores como volatilidade agrupada.

**Lema 4.1**: A estat√≠stica $LR_{ind}$ √© assintoticamente distribu√≠da como $\chi^2(1)$ sob a hip√≥tese nula de independ√™ncia serial das exce√ß√µes. Este resultado √© crucial para a aplica√ß√£o pr√°tica do teste, pois nos permite determinar se o modelo de VaR √© estatisticamente inadequado com base em um n√≠vel de signific√¢ncia pr√©-definido.

**Prova do Lema 4.1:**
Provaremos que a estat√≠stica $LR_{ind}$ √© assintoticamente distribu√≠da como $\chi^2(1)$ sob a hip√≥tese nula de independ√™ncia serial das exce√ß√µes.

I. A estat√≠stica $LR_{ind}$ √© dada por:
$$
LR_{ind} = - 2 \ln \left[ (1 - \pi)^{(T_{00} + T_{10})} \pi^{(T_{01} + T_{11})} \right] + 2 \ln \left[ (1 - \pi_0)^{T_{00}} \pi_0^{T_{01}} (1 - \pi_1)^{T_{10}} \pi_1^{T_{11}} \right]
$$

II. O primeiro termo corresponde √† log-verossimilhan√ßa sob a hip√≥tese nula de independ√™ncia, onde a probabilidade de uma exce√ß√£o √© $\pi$ em todos os per√≠odos. O segundo termo corresponde √† log-verossimilhan√ßa sob a hip√≥tese alternativa, onde a probabilidade de uma exce√ß√£o depende do estado do dia anterior, com probabilidades $\pi_0$ e $\pi_1$.

III. Sob a hip√≥tese nula, o modelo com depend√™ncia (hip√≥tese alternativa) se reduz ao modelo sem depend√™ncia (hip√≥tese nula), com $\pi_0 = \pi_1 = \pi$. Assim, a diferen√ßa no n√∫mero de par√¢metros entre o modelo com depend√™ncia e o modelo sem depend√™ncia √© igual a 1.

IV. Pela teoria assint√≥tica dos testes de raz√£o de verossimilhan√ßa, sob certas condi√ß√µes de regularidade (que geralmente se mant√™m em aplica√ß√µes pr√°ticas), a estat√≠stica $LR_{ind}$ segue uma distribui√ß√£o assint√≥tica qui-quadrado ($\chi^2$) com graus de liberdade igual √† diferen√ßa no n√∫mero de par√¢metros.

V. Portanto, $LR_{ind}$ √© assintoticamente distribu√≠da como $\chi^2(1)$ sob a hip√≥tese nula. ‚ñ†

**Corol√°rio 4.1**: A rejei√ß√£o da hip√≥tese nula com base na estat√≠stica $LR_{ind}$ implica que as exce√ß√µes do modelo de VaR n√£o s√£o serialmente independentes, indicando que o modelo pode apresentar inadequa√ß√µes ao n√£o capturar a din√¢mica de risco.

**Lema 4.2**: Sob a hip√≥tese nula de independ√™ncia serial, os estimadores $\pi_0$ e $\pi_1$ convergem para $\pi$ √† medida que o n√∫mero de observa√ß√µes aumenta. Este resultado √© fundamental para garantir a validade assint√≥tica do teste $LR_{ind}$.

**Prova do Lema 4.2**:
Sob a hip√≥tese nula de independ√™ncia, a probabilidade de uma exce√ß√£o em qualquer per√≠odo √© constante e igual a $\pi$. Os estimadores $\pi_0$ e $\pi_1$ s√£o, respectivamente, as frequ√™ncias relativas de exce√ß√µes condicionais a n√£o ter ocorrido uma exce√ß√£o no dia anterior, e a ter ocorrido uma exce√ß√£o no dia anterior. Pela lei dos grandes n√∫meros, √† medida que o n√∫mero de observa√ß√µes aumenta, estas frequ√™ncias relativas convergem para a probabilidade verdadeira do evento que est√£o estimando. No caso da hip√≥tese nula de independ√™ncia, a probabilidade de uma exce√ß√£o √© $\pi$ independentemente do estado do dia anterior. Assim, tanto $\pi_0$ quanto $\pi_1$ convergem para $\pi$ quando o tamanho amostral tende para o infinito. ‚ñ†

**Lema 4.3**: A estat√≠stica $LR_{ind}$ pode ser expressa de forma alternativa utilizando as probabilidades condicionais de transi√ß√£o. Seja $\hat{\pi}_{ij}$ a probabilidade de transi√ß√£o do estado $i$ para o estado $j$, definida como $\hat{\pi}_{ij} = T_{ij} / \sum_j T_{ij}$. Ent√£o,
$$
LR_{ind} = 2 \sum_{i=0}^1 \sum_{j=0}^1 T_{ij} \ln\left(\frac{\hat{\pi}_{ij}}{\pi_j}\right)
$$
onde $\pi_j$ √© a probabilidade marginal de estar no estado $j$, estimada como o n√∫mero total de ocorr√™ncias do estado $j$ dividido pelo n√∫mero total de observa√ß√µes.

**Prova do Lema 4.3**:
Vamos reescrever $LR_{ind}$ usando as probabilidades de transi√ß√£o:

I. Temos que $\pi = (T_{01} + T_{11}) / T$ e $\pi_0 = T_{01} / (T_{00} + T_{01})$ e $\pi_1 = T_{11} / (T_{10} + T_{11})$.
II. A estat√≠stica $LR_{ind}$ √© dada por:
$$
LR_{ind} = - 2 \ln \left[ (1 - \pi)^{(T_{00} + T_{10})} \pi^{(T_{01} + T_{11})} \right] + 2 \ln \left[ (1 - \pi_0)^{T_{00}} \pi_0^{T_{01}} (1 - \pi_1)^{T_{10}} \pi_1^{T_{11}} \right]
$$

III. A log-verossimilhan√ßa sob a hip√≥tese nula de independ√™ncia √© dada por:
$$
L_0 = (T_{00} + T_{10}) \ln(1-\pi) + (T_{01} + T_{11}) \ln(\pi)
$$

IV. E a log-verossimilhan√ßa sob a hip√≥tese alternativa √©:
$$
L_1 = T_{00}\ln(1-\pi_0) + T_{01}\ln(\pi_0) + T_{10}\ln(1-\pi_1) + T_{11}\ln(\pi_1)
$$

V.  O teste $LR_{ind}$ √© dado por $2(L_1 - L_0)$:
$$
LR_{ind} = 2[T_{00}\ln(1-\pi_0) + T_{01}\ln(\pi_0) + T_{10}\ln(1-\pi_1) + T_{11}\ln(\pi_1) - (T_{00} + T_{10}) \ln(1-\pi) - (T_{01} + T_{11}) \ln(\pi)]
$$

VI. Reorganizando os termos e usando a defini√ß√£o de $\hat{\pi}_{ij} = T_{ij} / \sum_j T_{ij}$ e as probabilidades marginais, a express√£o torna-se:
$$
LR_{ind} = 2 \sum_{i=0}^1 \sum_{j=0}^1 T_{ij} \ln\left(\frac{\hat{\pi}_{ij}}{\pi_j}\right)
$$
onde $\pi_j$ √© a probabilidade marginal de estar no estado $j$, estimada como o n√∫mero total de ocorr√™ncias do estado $j$ dividido pelo n√∫mero total de observa√ß√µes. ‚ñ†

Adicionalmente, para avaliar a *conditional coverage*, combinamos a estat√≠stica $LR_{ind}$ com a estat√≠stica de teste de *unconditional coverage* ($LR_{uc}$), resultando na estat√≠stica $LR_{cc}$:
$$
LR_{cc} = LR_{uc} + LR_{ind}
$$ [^1]

Onde $LR_{uc}$ √© definida como:
$$
LR_{uc} = -2 \ln[(1 - p)^{T-N} p^N] + 2 \ln[(1 - (N/T))^{T-N} (N/T)^N]
$$ [^1]
e $N$ √© o n√∫mero total de exce√ß√µes, $T$ √© o n√∫mero total de dias, e $p$ √© a probabilidade te√≥rica de uma exce√ß√£o (1 menos o n√≠vel de confian√ßa do VaR).

**Teorema 5**: A estat√≠stica $LR_{cc}$ √© assintoticamente distribu√≠da como $\chi^2(2)$ sob a hip√≥tese nula de que tanto a cobertura incondicional quanto a independ√™ncia serial s√£o v√°lidas. Este resultado √© uma consequ√™ncia da soma de duas vari√°veis $\chi^2(1)$ independentes, o que permite uma avalia√ß√£o conjunta da adequa√ß√£o do modelo.

**Prova do Teorema 5:**

I. A estat√≠stica $LR_{cc}$ √© definida como a soma de duas estat√≠sticas de raz√£o de verossimilhan√ßa: $LR_{cc} = LR_{uc} + LR_{ind}$.

II. Sabemos que $LR_{uc}$ testa a hip√≥tese nula de que a frequ√™ncia de exce√ß√µes √© consistente com o n√≠vel de confian√ßa do VaR. Sob a hip√≥tese nula, $LR_{uc}$ √© assintoticamente distribu√≠da como $\chi^2(1)$.

III. Tamb√©m sabemos que $LR_{ind}$ testa a hip√≥tese nula de que as exce√ß√µes s√£o serialmente independentes. Sob a hip√≥tese nula, $LR_{ind}$ √© assintoticamente distribu√≠da como $\chi^2(1)$ (Lema 4.1).

IV. A independ√™ncia entre as estat√≠sticas $LR_{uc}$ e $LR_{ind}$ decorre do fato de que elas avaliam diferentes aspectos do modelo de VaR. $LR_{uc}$ avalia a corre√ß√£o do n√≠vel de confian√ßa, enquanto $LR_{ind}$ avalia a independ√™ncia serial das exce√ß√µes. Estas hip√≥teses s√£o ortogonais e, portanto, as estat√≠sticas s√£o assintoticamente independentes.

V. Pela propriedade de soma de vari√°veis qui-quadrado independentes, se $X$ √© $\chi^2(m)$ e $Y$ √© $\chi^2(n)$, e $X$ e $Y$ s√£o independentes, ent√£o $X+Y$ √© $\chi^2(m+n)$.

VI. Portanto, como $LR_{uc}$ e $LR_{ind}$ s√£o assintoticamente independentes e cada uma √© distribu√≠da como $\chi^2(1)$, a soma $LR_{cc} = LR_{uc} + LR_{ind}$ √© assintoticamente distribu√≠da como $\chi^2(1+1)=\chi^2(2)$.  ‚ñ†

**Corol√°rio 5.1**: A rejei√ß√£o da hip√≥tese nula com base na estat√≠stica $LR_{cc}$ sugere que o modelo de VaR apresenta problemas, seja devido a uma cobertura incondicional inadequada, √† depend√™ncia serial das exce√ß√µes, ou a ambos.

> üí° **Exemplo Cont√≠nuo**: Retomando o exemplo anterior, vamos supor que o n√∫mero total de exce√ß√µes √© de $N = 20$.  Podemos calcular $LR_{uc}$:
>
>  $$
>  LR_{uc} = -2 \ln[(1 - 0.01)^{250-20} (0.01)^{20}] + 2 \ln[(1 - (20/250))^{250-20} (20/250)^{20}]
> $$
>
> $$
>  LR_{uc} = -2 \ln[(0.99)^{230} (0.01)^{20}] + 2 \ln[(0.92)^{230} (0.08)^{20}] \approx 184.60 - 159.69 = 24.91
> $$
>
> A estat√≠stica combinada $LR_{cc}$ √©:
>
> $$
>  LR_{cc} = LR_{uc} + LR_{ind} = 24.91 + 12.2 = 37.11
> $$
>
> O valor cr√≠tico da distribui√ß√£o $\chi^2(2)$ a 5% de signific√¢ncia √© 5.991. Como $37.11 > 5.991$, rejeitamos a hip√≥tese nula, indicando que o modelo de VaR √© inadequado em termos de cobertura incondicional e de independ√™ncia serial das exce√ß√µes.
>
> ```python
> import numpy as np
> from scipy.stats import chi2
>
> T = 250
> N = 20
> p = 0.01
>
> lr_uc = -2 * np.log((1-p)**(T-N) * p**N) + 2 * np.log((1-(N/T))**(T-N) * (N/T)**N)
>
> lr_ind = 12.2 # From previous example
>
> lr_cc = lr_uc + lr_ind
>
> print(f"LR_uc: {lr_uc:.2f}")
> print(f"LR_ind: {lr_ind:.2f}")
> print(f"LR_cc: {lr_cc:.2f}")
>
> critical_value_cc = chi2.ppf(0.95, 2)
> print(f"Critical value (chi2(2), 5%): {critical_value_cc:.3f}")
>
> if lr_cc > critical_value_cc:
>     print("Reject the null hypothesis: The model is inadequate.")
> else:
>    print("Fail to reject the null hypothesis: The model is adequate")
> ```
> **Interpreta√ß√£o:** O valor de $LR_{cc}$ √© 37.11, que √© muito maior do que o valor cr√≠tico de 5.991 para uma distribui√ß√£o $\chi^2(2)$ com 5% de signific√¢ncia. Isso significa que rejeitamos a hip√≥tese nula de que o modelo de VaR √© adequado tanto em termos de cobertura incondicional quanto de independ√™ncia serial. A alta estat√≠stica $LR_{uc}$ j√° indica uma m√° calibra√ß√£o da frequ√™ncia de exce√ß√µes e, combinada com $LR_{ind}$, mostra que as exce√ß√µes est√£o agrupadas no tempo, o que significa que o modelo subestima o risco em determinados per√≠odos e, portanto, n√£o √© adequado.

**Observa√ß√£o 11**: A escolha do n√≠vel de signific√¢ncia para os testes $LR_{ind}$ e $LR_{cc}$ deve ser feita com cautela, considerando o trade-off entre o risco de rejeitar um modelo adequado (erro tipo I) e o risco de n√£o rejeitar um modelo inadequado (erro tipo II). Um n√≠vel de signific√¢ncia de 5% √© comumente utilizado em aplica√ß√µes financeiras, mas outros valores podem ser apropriados dependendo do contexto e das prefer√™ncias do analista.

**Observa√ß√£o 12:** Uma limita√ß√£o do teste $LR_{ind}$ √© que ele considera apenas depend√™ncia de primeira ordem (i.e., a depend√™ncia da exce√ß√£o de hoje com a exce√ß√£o de ontem).  Extens√µes podem ser constru√≠das para levar em conta depend√™ncias de ordens mais altas, usando tabelas de transi√ß√£o que consideram mais do que um dia anterior.

### Conclus√£o
Em resumo, a estat√≠stica de raz√£o de verossimilhan√ßa para independ√™ncia ($LR_{ind}$) √© uma ferramenta essencial nos testes de *conditional coverage*, permitindo avaliar se as exce√ß√µes de um modelo de VaR s√£o serialmente independentes. A combina√ß√£o de $LR_{ind}$ com a estat√≠stica de *unconditional coverage* ($LR_{uc}$) atrav√©s de $LR_{cc}$ fornece uma avalia√ß√£o abrangente da adequa√ß√£o do modelo, verificando tanto o n√∫mero de exce√ß√µes quanto a sua distribui√ß√£o temporal. Ao utilizar esses testes, institui√ß√µes financeiras podem garantir que seus modelos de VaR sejam precisos, robustos e confi√°veis, e capazes de capturar as din√¢micas do risco de forma adequada. A aplica√ß√£o destes testes permite identificar e corrigir eventuais falhas nos modelos, assegurando que as decis√µes de gest√£o de risco sejam tomadas com base em informa√ß√µes precisas e completas.

### Refer√™ncias
[^1]: Cap√≠tulo 6 do texto fornecido.
<!-- END -->
