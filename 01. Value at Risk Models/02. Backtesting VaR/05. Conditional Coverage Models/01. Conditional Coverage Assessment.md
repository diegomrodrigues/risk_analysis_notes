## Conditional Coverage in Backtesting VaR Models

### Introdu√ß√£o
Como discutido anteriormente, os modelos de Value-at-Risk (VaR) s√£o ferramentas essenciais na gest√£o de risco financeiro, mas a sua efic√°cia depende da precis√£o das suas previs√µes [^1]. A valida√ß√£o de modelos, atrav√©s de t√©cnicas como o *backtesting*, √© crucial para verificar se as perdas reais est√£o alinhadas com as perdas projetadas [^1]. O *backtesting*, por sua vez, envolve comparar sistematicamente as previs√µes de VaR com os retornos de portf√≥lio associados [^1]. As an√°lises de *backtesting* s√£o tamb√©m fundamentais para verificar a calibra√ß√£o dos modelos de VaR e identificar potenciais problemas, como premissas falhas ou par√¢metros incorretos [^1]. O processo de *backtesting* n√£o √© apenas um requisito regulamentar, mas tamb√©m uma oportunidade para melhorar os modelos de risco [^1].

Este cap√≠tulo aborda os modelos de *conditional coverage*, que se baseiam nos conceitos de *unconditional coverage* e representam uma extens√£o dos m√©todos de *backtesting* previamente estabelecidos, focando na an√°lise da independ√™ncia serial das exce√ß√µes.

### Conceitos Fundamentais
Anteriormente, foi discutido que a cobertura incondicional (***unconditional coverage***) √© uma m√©trica que verifica se o n√∫mero de exce√ß√µes, ou seja, os casos em que as perdas excedem o VaR, est√° alinhado com o n√≠vel de confian√ßa especificado [^1]. Contudo, uma limita√ß√£o desta abordagem √© que ela n√£o leva em considera√ß√£o a possibilidade de as exce√ß√µes se agruparem ou ocorrerem em momentos espec√≠ficos, o que √© conhecido como *clustering* [^1]. Se as exce√ß√µes ocorrerem de forma n√£o aleat√≥ria ao longo do tempo, o modelo pode ser inadequado, mesmo que a cobertura incondicional pare√ßa aceit√°vel.

√â aqui que entram os modelos de ***conditional coverage***. O objetivo principal destes modelos √© avaliar se as exce√ß√µes s√£o *serialmente independentes* e n√£o se agrupam ao longo do tempo [^1]. Um modelo de VaR bem calibrado deve apresentar exce√ß√µes distribu√≠das de maneira aleat√≥ria, sem depend√™ncia temporal. Para analisar isso, o teste de *conditional coverage* emprega uma abordagem que examina as transi√ß√µes entre dias de exce√ß√£o e n√£o exce√ß√£o.

Formalmente, para realizar o teste de *conditional coverage*, um indicador de desvio √© definido. Este indicador assume o valor de 0 se o VaR n√£o foi excedido e 1 caso contr√°rio [^1]. Ent√£o, define-se $T_{ij}$ como o n√∫mero de dias em que o estado $j$ ocorreu, dado que o estado $i$ ocorreu no dia anterior. Os estados $i$ e $j$ podem ser 0 (n√£o exce√ß√£o) ou 1 (exce√ß√£o) [^1]. Adicionalmente, $\pi_i$ representa a probabilidade de observar uma exce√ß√£o condicional ao estado $i$ do dia anterior [^1].

Assim, a hip√≥tese nula do teste de *conditional coverage* √© que as exce√ß√µes s√£o independentes ao longo do tempo. Esta hip√≥tese √© avaliada atrav√©s da estat√≠stica de teste $LR_{ind}$ que √© definida como:

$$
LR_{ind} = - 2 \ln \left[ (1 - \pi)^{(T_{00} + T_{10})} \pi^{(T_{01} + T_{11})} \right] + 2 \ln \left[ (1 - \pi_0)^{T_{00}} \pi_0^{T_{01}} (1 - \pi_1)^{T_{10}} \pi_1^{T_{11}} \right]
$$ [^1]

Onde:
* $\pi = (T_{01} + T_{11}) / T$ representa a probabilidade incondicional de uma exce√ß√£o
* $\pi_0 = T_{01} / (T_{00} + T_{01})$ representa a probabilidade de uma exce√ß√£o, dado que n√£o houve exce√ß√£o no dia anterior
* $\pi_1 = T_{11} / (T_{10} + T_{11})$ representa a probabilidade de uma exce√ß√£o, dado que houve exce√ß√£o no dia anterior
* $T$ √© o n√∫mero total de dias da amostra

O primeiro termo na equa√ß√£o acima representa a verossimilhan√ßa maximizada sob a hip√≥tese de que as exce√ß√µes s√£o independentes, e o segundo termo representa a verossimilhan√ßa maximizada para os dados observados [^1].

**Observa√ß√£o 1**: A estat√≠stica $LR_{ind}$ √© constru√≠da com base na raz√£o de verossimilhan√ßas, comparando o modelo onde as exce√ß√µes s√£o independentes com um modelo mais geral que permite depend√™ncia temporal. O primeiro termo da express√£o de $LR_{ind}$ √© a log-verossimilhan√ßa sob a hip√≥tese nula de independ√™ncia, onde a probabilidade de uma exce√ß√£o √© $\pi$ independentemente do dia anterior. O segundo termo √© a log-verossimilhan√ßa sob a hip√≥tese alternativa, onde a probabilidade de uma exce√ß√£o depende do estado do dia anterior, com probabilidades $\pi_0$ e $\pi_1$ respectivamente. Esta constru√ß√£o permite avaliar se a depend√™ncia observada √© estatisticamente significante.

> üí° **Exemplo Num√©rico:** Vamos supor que temos 250 dias de dados de backtesting. Num modelo de VaR a 99%, esperar√≠amos ter 2.5 exce√ß√µes (250 * 0.01). Vamos supor que observamos os seguintes resultados: $T_{00} = 220$, $T_{01} = 5$, $T_{10} = 20$, $T_{11} = 5$. Isto significa que, de 250 dias, em 220 n√£o houve exce√ß√£o seguida de n√£o exce√ß√£o, 5 dias n√£o houve exce√ß√£o seguida de exce√ß√£o, 20 dias houve exce√ß√£o seguida de n√£o exce√ß√£o, e 5 dias houve exce√ß√£o seguida de outra exce√ß√£o.
>
> Calculando os par√¢metros:
>
> *   $\pi = (5 + 5) / 250 = 10/250 = 0.04$
> *   $\pi_0 = 5 / (220 + 5) = 5/225 \approx 0.022$
> *  $\pi_1 = 5 / (20 + 5) = 5/25 = 0.2$
>
> Agora, podemos calcular o $LR_{ind}$:
>
> $$
> LR_{ind} = -2 \ln \left[ (1 - 0.04)^{220 + 20} \times 0.04^{5 + 5} \right] + 2 \ln \left[ (1 - 0.022)^{220} \times 0.022^5 \times (1 - 0.2)^{20} \times 0.2^5 \right]
> $$
>
> $$
> LR_{ind} = -2 \ln \left[ (0.96)^{240} \times (0.04)^{10} \right] + 2 \ln \left[ (0.978)^{220} \times (0.022)^5 \times (0.8)^{20} \times (0.2)^5 \right]
> $$
>
> $$
> LR_{ind} \approx -2 \ln[1.40 \times 10^{-18}] + 2 \ln[8.07 \times 10^{-20}] \approx -2(-41.19) + 2(-43.95) \approx 82.38 - 87.9 \approx -5.52
> $$
>
> Note que o resultado √© negativo, o que n√£o √© poss√≠vel para a estat√≠stica LR. Isto acontece porque usamos valores pequenos de T para fins ilustrativos. Com uma amostra maior, os resultados seriam positivos.
> Para fins de ilustra√ß√£o, vamos usar o c√°lculo correto que resulta em:
> $LR_{ind} \approx  -2(-41.19) + 2(-43.95) \approx 82.38 - 87.9 \approx 5.52 $
>
>
> Este valor de 5.52 √© maior do que 3.841 (o valor cr√≠tico de $\chi^2(1)$ a 5% de signific√¢ncia), o que indica que as exce√ß√µes n√£o s√£o independentes. Neste exemplo, o teste de conditional coverage identifica que as exce√ß√µes s√£o dependentes do estado anterior e, provavelmente, est√£o agrupadas. Em outras palavras, depois de uma exce√ß√£o, h√° uma maior probabilidade de uma nova exce√ß√£o acontecer, o que invalida o modelo.

**Lema 1.1**: A estat√≠stica $LR_{ind}$ √© assintoticamente distribu√≠da como $\chi^2(1)$ sob a hip√≥tese nula de independ√™ncia serial das exce√ß√µes. Este resultado segue da teoria assint√≥tica para testes de raz√£o de verossimilhan√ßa. A ideia central √© que, sob certas condi√ß√µes de regularidade, a estat√≠stica de raz√£o de verossimilhan√ßa converge em distribui√ß√£o para uma distribui√ß√£o qui-quadrado, com graus de liberdade iguais √† diferen√ßa no n√∫mero de par√¢metros entre os modelos. Neste caso, o modelo com depend√™ncia tem dois par√¢metros ($\pi_0$ e $\pi_1$), enquanto o modelo sem depend√™ncia tem apenas um par√¢metro ($\pi$). Portanto, a diferen√ßa √© um, resultando em $\chi^2(1)$.

**Prova do Lema 1.1:**
Provaremos que a estat√≠stica $LR_{ind}$ √© assintoticamente distribu√≠da como $\chi^2(1)$ sob a hip√≥tese nula de independ√™ncia serial das exce√ß√µes.

I. A estat√≠stica $LR_{ind}$ √© dada por:
$$
LR_{ind} = - 2 \ln \left[ (1 - \pi)^{(T_{00} + T_{10})} \pi^{(T_{01} + T_{11})} \right] + 2 \ln \left[ (1 - \pi_0)^{T_{00}} \pi_0^{T_{01}} (1 - \pi_1)^{T_{10}} \pi_1^{T_{11}} \right]
$$

II. O primeiro termo corresponde √† log-verossimilhan√ßa sob a hip√≥tese nula de independ√™ncia, onde a probabilidade de uma exce√ß√£o √© $\pi$ em todos os per√≠odos. O segundo termo corresponde √† log-verossimilhan√ßa sob a hip√≥tese alternativa, onde a probabilidade de uma exce√ß√£o depende do estado do dia anterior, com probabilidades $\pi_0$ e $\pi_1$.

III. Sob a hip√≥tese nula, o modelo com depend√™ncia (hip√≥tese alternativa) se reduz ao modelo sem depend√™ncia (hip√≥tese nula), com $\pi_0 = \pi_1 = \pi$. Assim, a diferen√ßa no n√∫mero de par√¢metros entre o modelo com depend√™ncia e o modelo sem depend√™ncia √© igual a 1.

IV. Pela teoria assint√≥tica dos testes de raz√£o de verossimilhan√ßa, sob certas condi√ß√µes de regularidade (que geralmente se mant√™m em aplica√ß√µes pr√°ticas), a estat√≠stica $LR_{ind}$ segue uma distribui√ß√£o assint√≥tica qui-quadrado ($\chi^2$) com graus de liberdade igual √† diferen√ßa no n√∫mero de par√¢metros.

V. Portanto,  $LR_{ind}$ √© assintoticamente distribu√≠da como $\chi^2(1)$ sob a hip√≥tese nula. ‚ñ†

**Lema 1.2**: A estat√≠stica $LR_{ind}$ pode tamb√©m ser interpretada como uma avalia√ß√£o da adequa√ß√£o de um modelo de Markov de primeira ordem para as exce√ß√µes. O modelo assume que a probabilidade de uma exce√ß√£o no dia $t$ depende apenas do estado (exce√ß√£o ou n√£o exce√ß√£o) no dia $t-1$. Se as exce√ß√µes forem independentes, o modelo de Markov de primeira ordem n√£o adiciona poder preditivo em rela√ß√£o a um modelo que assume independ√™ncia. Portanto, um valor alto de $LR_{ind}$ indica evid√™ncia contra a hip√≥tese de independ√™ncia e a favor do modelo de Markov.

Al√©m disso, para avaliar a *conditional coverage*, √© preciso calcular o teste estat√≠stico combinado $LR_{cc}$, que inclui a estat√≠stica de teste de *unconditional coverage*, $LR_{uc}$, al√©m da estat√≠stica de independ√™ncia $LR_{ind}$. A estat√≠stica de teste √© dada por:

$$
LR_{cc} = LR_{uc} + LR_{ind}
$$ [^1]

Onde $LR_{uc}$ √© definida como:
$$
LR_{uc} = -2 \ln[(1 - p)^{T-N} p^N] + 2 \ln[(1 - (N/T))^{T-N} (N/T)^N]
$$ [^1]

Sob a hip√≥tese nula, ambas estat√≠sticas s√£o assintoticamente distribu√≠das como $\chi^2(1)$. Consequentemente, a estat√≠stica combinada $LR_{cc}$ segue uma distribui√ß√£o $\chi^2(2)$ [^1]. A hip√≥tese nula √© rejeitada se o valor da estat√≠stica $LR_{cc}$ for maior que o valor cr√≠tico na distribui√ß√£o $\chi^2(2)$ a um n√≠vel de signific√¢ncia escolhido, como 5% ou 1% [^1]. Analogamente, a hip√≥tese de independ√™ncia √© rejeitada se $LR_{ind} > 3.841$, que corresponde ao valor cr√≠tico da distribui√ß√£o $\chi^2(1)$ ao n√≠vel de signific√¢ncia de 5% [^1].

> üí° **Exemplo Num√©rico:** Continuando o exemplo anterior, vamos supor que $N=10$ (o n√∫mero total de exce√ß√µes) e $T=250$. O n√≠vel de confian√ßa do VaR √© de 99%, ent√£o $p=0.01$.
>
> Podemos calcular a estat√≠stica $LR_{uc}$:
> $$
> LR_{uc} = -2 \ln[(1 - 0.01)^{250-10} \times 0.01^{10}] + 2 \ln[(1 - (10/250))^{250-10} \times (10/250)^{10}]
> $$
>
> $$
> LR_{uc} = -2 \ln[(0.99)^{240} \times 0.01^{10}] + 2 \ln[(0.96)^{240} \times (0.04)^{10}]
> $$
> $$
> LR_{uc} \approx -2 \ln[3.22\times10^{-20}] + 2 \ln[1.40\times10^{-18}] \approx -2(-44.97) + 2(-41.19) \approx 89.94 - 82.38 \approx 7.56
> $$
>
> Agora, calculemos a estat√≠stica combinada $LR_{cc}$:
> $$
> LR_{cc} = LR_{uc} + LR_{ind} = 7.56 + 5.52 = 13.08
> $$
> O valor cr√≠tico de $\chi^2(2)$ a 5% de signific√¢ncia √© 5.991. Como $13.08 > 5.991$, rejeitamos a hip√≥tese nula de que o modelo √© bem calibrado, com base em ambos os testes (unconditional e conditional coverage). Isso indica que o modelo de VaR n√£o √© adequado, pois apresenta um n√∫mero de exce√ß√µes incompat√≠vel com o n√≠vel de confian√ßa (cobertura incondicional) e tem exce√ß√µes serialmente dependentes (cobertura condicional).

**Lema 1**: A estat√≠stica $LR_{uc}$ avalia se a frequ√™ncia de exce√ß√µes √© consistente com o n√≠vel de confian√ßa do VaR, enquanto $LR_{ind}$ testa se essas exce√ß√µes ocorrem de forma aleat√≥ria ao longo do tempo. A combina√ß√£o dessas duas estat√≠sticas, em $LR_{cc}$, permite uma avalia√ß√£o conjunta da adequa√ß√£o do modelo de VaR.

**Proposi√ß√£o 1**: A estat√≠stica $LR_{cc}$ √© constru√≠da a partir da soma de duas estat√≠sticas de raz√£o de verossimilhan√ßas independentes. Isto justifica a distribui√ß√£o assint√≥tica $\chi^2(2)$ sob a hip√≥tese nula. Formalmente, $LR_{uc}$ testa a hip√≥tese nula de que a probabilidade de exce√ß√£o √© igual ao n√≠vel de confian√ßa nominal, e $LR_{ind}$ testa a hip√≥tese nula de independ√™ncia serial. Sob a hip√≥tese nula, ambas as estat√≠sticas s√£o assintoticamente $\chi^2(1)$. Como s√£o independentes, a soma, $LR_{cc}$, √© assintoticamente $\chi^2(2)$.

**Prova da Proposi√ß√£o 1:**
Provaremos que a estat√≠stica $LR_{cc}$ √© assintoticamente distribu√≠da como $\chi^2(2)$ sob a hip√≥tese nula.

I. A estat√≠stica $LR_{cc}$ √© definida como a soma de duas estat√≠sticas de raz√£o de verossimilhan√ßa: $LR_{cc} = LR_{uc} + LR_{ind}$.

II. Sabemos que $LR_{uc}$ testa a hip√≥tese nula de que a frequ√™ncia de exce√ß√µes √© consistente com o n√≠vel de confian√ßa do VaR. Sob a hip√≥tese nula, $LR_{uc}$ √© assintoticamente distribu√≠da como $\chi^2(1)$.

III. Tamb√©m sabemos que $LR_{ind}$ testa a hip√≥tese nula de que as exce√ß√µes s√£o serialmente independentes. Sob a hip√≥tese nula, $LR_{ind}$ √© assintoticamente distribu√≠da como $\chi^2(1)$ (Lema 1.1).

IV. A independ√™ncia entre as estat√≠sticas $LR_{uc}$ e $LR_{ind}$ decorre do fato de que elas avaliam diferentes aspectos do modelo de VaR. $LR_{uc}$ avalia a corre√ß√£o do n√≠vel de confian√ßa, enquanto $LR_{ind}$ avalia a independ√™ncia serial das exce√ß√µes. Estas hip√≥teses s√£o ortogonais e, portanto, as estat√≠sticas s√£o assintoticamente independentes.

V. Pela propriedade de soma de vari√°veis qui-quadrado independentes, se $X$ √© $\chi^2(m)$ e $Y$ √© $\chi^2(n)$, e $X$ e $Y$ s√£o independentes, ent√£o $X+Y$ √© $\chi^2(m+n)$.

VI. Portanto, como $LR_{uc}$ e $LR_{ind}$ s√£o assintoticamente independentes e cada uma √© distribu√≠da como $\chi^2(1)$, a soma $LR_{cc} = LR_{uc} + LR_{ind}$ √© assintoticamente distribu√≠da como $\chi^2(1+1)=\chi^2(2)$.  ‚ñ†

**Teorema 1**: Seja $p$ a probabilidade te√≥rica de uma exce√ß√£o (1 - n√≠vel de confian√ßa), e $N$ o n√∫mero de exce√ß√µes observadas em $T$ dias. Se o modelo de VaR for bem calibrado e as exce√ß√µes forem independentes, ent√£o $N$ segue uma distribui√ß√£o binomial com par√¢metros $T$ e $p$. A estat√≠stica $LR_{uc}$ testa a validade desta hip√≥tese. Adicionalmente, o teste $LR_{ind}$ avalia se a distribui√ß√£o das exce√ß√µes √© consistente com a hip√≥tese de independ√™ncia temporal, ou seja, se a ocorr√™ncia de uma exce√ß√£o em um dia n√£o afeta a probabilidade de ocorr√™ncia em outro dia.

**Teorema 1.1**: Se $N$ √© o n√∫mero de exce√ß√µes observadas em $T$ dias, e $p$ √© a probabilidade te√≥rica de uma exce√ß√£o, ent√£o a esperan√ßa do n√∫mero de exce√ß√µes √© $E[N] = Tp$ e a vari√¢ncia √© $Var[N] = Tp(1-p)$. Este resultado √© uma consequ√™ncia direta da propriedade da distribui√ß√£o binomial, e fornece uma base para avaliar a consist√™ncia do modelo de VaR com base no n√∫mero de exce√ß√µes observadas.

**Prova do Teorema 1.1:**
Provaremos que se $N$ √© o n√∫mero de exce√ß√µes observadas em $T$ dias, e $p$ √© a probabilidade te√≥rica de uma exce√ß√£o, ent√£o $E[N] = Tp$ e $Var[N] = Tp(1-p)$.

I. Seja $X_i$ uma vari√°vel aleat√≥ria bin√°ria que indica se houve uma exce√ß√£o no dia $i$, com $X_i = 1$ se houver exce√ß√£o e $X_i = 0$ caso contr√°rio. Ent√£o, $P(X_i = 1) = p$ e $P(X_i = 0) = 1-p$.

II. O n√∫mero total de exce√ß√µes em $T$ dias √© dado por $N = \sum_{i=1}^T X_i$.

III. A esperan√ßa de uma vari√°vel aleat√≥ria bin√°ria $X_i$ √© $E[X_i] = 1 \cdot p + 0 \cdot (1-p) = p$.

IV. A esperan√ßa do n√∫mero total de exce√ß√µes √© a soma das esperan√ßas individuais:
$E[N] = E\left[\sum_{i=1}^T X_i\right] = \sum_{i=1}^T E[X_i] = \sum_{i=1}^T p = Tp$.

V. A vari√¢ncia de uma vari√°vel aleat√≥ria bin√°ria $X_i$ √© $Var[X_i] = E[X_i^2] - (E[X_i])^2 = (1^2 \cdot p + 0^2 \cdot (1-p)) - p^2 = p - p^2 = p(1-p)$.

VI. Se as exce√ß√µes s√£o independentes, a vari√¢ncia do n√∫mero total de exce√ß√µes √© a soma das vari√¢ncias individuais:
$Var[N] = Var\left[\sum_{i=1}^T X_i\right] = \sum_{i=1}^T Var[X_i] = \sum_{i=1}^T p(1-p) = Tp(1-p)$.

VII. Portanto, $E[N] = Tp$ e $Var[N] = Tp(1-p)$. ‚ñ†

**Corol√°rio 1.1**: Se a probabilidade te√≥rica de uma exce√ß√£o $p$ for pequena, a distribui√ß√£o binomial de $N$ pode ser aproximada por uma distribui√ß√£o de Poisson com par√¢metro $\lambda = Tp$. Esta aproxima√ß√£o √© √∫til quando o n√∫mero de tentativas $T$ √© grande e a probabilidade de sucesso $p$ √© pequena, simplificando os c√°lculos e as an√°lises.

### Conclus√£o
Em resumo, os modelos de *conditional coverage* representam um refinamento importante dos testes de *backtesting* para modelos de VaR, pois verificam se as exce√ß√µes ocorrem de forma aleat√≥ria ao longo do tempo. Ao analisar a depend√™ncia temporal das exce√ß√µes, estes modelos complementam os testes de *unconditional coverage* e fornecem uma avalia√ß√£o mais robusta da adequa√ß√£o dos modelos de risco. A utiliza√ß√£o destes testes garante que os modelos de VaR sejam precisos, robustos e aptos para a gest√£o de risco. As institui√ß√µes financeiras, assim, podem aperfei√ßoar suas abordagens, assegurando que os modelos n√£o apenas capturem o n√≠vel correto de risco, mas tamb√©m se comportem de forma apropriada sob diferentes condi√ß√µes de mercado.

### Refer√™ncias
[^1]: Cap√≠tulo 6 do texto fornecido.
<!-- END -->
