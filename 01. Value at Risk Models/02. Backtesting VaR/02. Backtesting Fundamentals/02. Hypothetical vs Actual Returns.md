## Diferenciando Retornos Reais e Hipot√©ticos em Backtesting de VAR

### Introdu√ß√£o
Em continuidade ao que foi abordado sobre *backtesting* de modelos VAR, e como visto anteriormente, √© crucial distinguir entre retornos reais e hipot√©ticos para uma avalia√ß√£o precisa do modelo [^1]. O processo de *backtesting*, conforme estabelecido, envolve a compara√ß√£o das previs√µes de perdas do modelo VAR com as perdas reais observadas [^1]. Esta se√ß√£o ir√° aprofundar como a distin√ß√£o entre retornos reais (P&L) e retornos hipot√©ticos √© fundamental para uma an√°lise de *backtesting* eficaz, complementando a discuss√£o sobre a import√¢ncia da calibra√ß√£o e do uso de retornos *cleaned* [^2]. A escolha correta entre estes tipos de retornos, e seu impacto no processo de valida√ß√£o, √© fundamental para uma gest√£o de riscos eficiente e para a conformidade regulat√≥ria [^4].

### Conceitos Fundamentais
No *backtesting* de modelos VAR, a utiliza√ß√£o de retornos reais e hipot√©ticos desempenha pap√©is distintos e complementares. Os **retornos reais** (P&L) refletem o resultado efetivo das opera√ß√µes financeiras, incluindo todos os efeitos das negocia√ß√µes intradi√°rias, taxas, comiss√µes e outros itens n√£o *mark-to-market* [^3]. Por outro lado, os **retornos hipot√©ticos**, $R^*$, representam o desempenho de um portf√≥lio que permanece fixo, ou "congelado", durante o per√≠odo de avalia√ß√£o, sem qualquer altera√ß√£o nas posi√ß√µes [^3]. Esses retornos s√£o calculados usando as posi√ß√µes do portf√≥lio no fechamento do dia anterior e aplicadas aos retornos dos ativos medidos de fechamento a fechamento [^4].

> üí° **A relev√¢ncia dos retornos hipot√©ticos:** O uso de retornos hipot√©ticos √© crucial para avaliar a calibra√ß√£o do modelo VAR em si, isolando-o das mudan√ßas di√°rias na composi√ß√£o do portf√≥lio [^4]. Enquanto os retornos reais podem ser afetados por estrat√©gias de negocia√ß√£o e ajustes de posi√ß√£o, os retornos hipot√©ticos permitem verificar se o modelo est√° adequadamente capturando o risco inerente aos ativos mantidos, conforme discutido no teorema 1.1.
> ```mermaid
> graph LR
>   A[Portf√≥lio] --> B(Posi√ß√µes fixas no fechamento do dia t-1);
>   B --> C(Retornos di√°rios dos ativos);
>   C --> D(Retorno Hipot√©tico R*);
>   A --> E(Negocia√ß√µes intradi√°rias e taxas);
>   E --> F(Retorno Real R);
> ```
> üí° **Exemplo Num√©rico:** Imagine um portf√≥lio composto por a√ß√µes da Petrobras (PETR4) e Vale (VALE3). No final do dia t-1, o portf√≥lio tem as seguintes posi√ß√µes: 100 a√ß√µes de PETR4 e 50 a√ß√µes de VALE3.
>
> *   **Retorno Real (R):** Durante o dia t, o gestor decide vender 20 a√ß√µes de PETR4 e comprar 10 a√ß√µes de VALE3, al√©m de incorrer em taxas de corretagem de R\$ 10. Ao final do dia, o valor do portf√≥lio aumentou em R\$ 500. O retorno real (R) √© calculado como a varia√ß√£o total do valor do portf√≥lio, incluindo as negocia√ß√µes e taxas.
>
> *   **Retorno Hipot√©tico (R*):** Para calcular o retorno hipot√©tico (R*), consideramos as posi√ß√µes de fechamento do dia t-1 (100 PETR4 e 50 VALE3) e aplicamos os retornos di√°rios de cada a√ß√£o. Suponha que PETR4 tenha tido um retorno de 2% e VALE3 de 3% no dia t. O retorno hipot√©tico seria (100 * 0.02 * pre√ßo\_PETR4\_t-1) + (50 * 0.03 * pre√ßo\_VALE3\_t-1), em valores monet√°rios. Para calcular a porcentagem, ter√≠amos que dividir pelo valor total do portf√≥lio em t-1.

**Proposi√ß√£o 2:** *Os retornos hipot√©ticos fornecem uma medida mais precisa da performance do modelo VAR, pois eliminam a influ√™ncia das atividades de trading intraday, permitindo que a avalia√ß√£o se concentre na precis√£o das previs√µes de risco do modelo.*

*Proof:*
I. Retornos reais incluem o impacto de ajustes de posi√ß√£o e negocia√ß√µes ao longo do dia, o que pode introduzir ru√≠do na avalia√ß√£o do modelo VAR.
II. Retornos hipot√©ticos s√£o calculados mantendo as posi√ß√µes fixas, o que permite isolar o efeito do risco de mercado sobre as posi√ß√µes existentes.
III. A diferen√ßa entre retornos reais e hipot√©ticos reside na din√¢mica da carteira.
IV. Ao utilizar retornos hipot√©ticos, o foco √© a performance do modelo VAR em um cen√°rio est√°tico, tornando a avalia√ß√£o mais focada na capacidade do modelo de prever o risco de mercado. ‚ñ†

**Lema 2.1:** *Seja $P_t$ o valor do portf√≥lio no tempo $t$, e $P_{t-1}$ o valor no tempo $t-1$. O retorno real $R_t$ √© dado por $R_t = \frac{P_t - P_{t-1}}{P_{t-1}}$, enquanto o retorno hipot√©tico $R^*_t$ √© calculado utilizando as posi√ß√µes de $P_{t-1}$ e os retornos dos ativos de $t-1$ para $t$.*

*Proof:*
I. O retorno real $R_t$ √© a varia√ß√£o percentual no valor do portf√≥lio entre os instantes $t-1$ e $t$, refletindo todas as opera√ß√µes e ajustes realizados durante o dia $t$.
II. O retorno hipot√©tico $R^*_t$  considera o valor hipot√©tico do portf√≥lio se as posi√ß√µes fossem mantidas intactas.
III. O c√°lculo do retorno hipot√©tico envolve aplicar os retornos de mercado observados no dia $t$ √†s posi√ß√µes do portf√≥lio ao final do dia $t-1$.
IV. Portanto, $R_t$ e $R^*_t$ diferem devido √†s negocia√ß√µes intradi√°rias, taxas e outros fatores n√£o *mark-to-market* inclu√≠dos em $R_t$ mas n√£o em $R^*_t$. ‚ñ†

**Lema 2.2:** *Seja $w_{i, t-1}$ o peso do ativo $i$ no portf√≥lio no tempo $t-1$ e $r_{i,t}$ o retorno do ativo $i$ do tempo $t-1$ para $t$. Ent√£o, o retorno hipot√©tico $R^*_t$ pode ser calculado como $R^*_t = \sum_{i=1}^{n} w_{i, t-1} r_{i,t}$, onde $n$ √© o n√∫mero total de ativos no portf√≥lio.*

*Proof:*
I. O retorno hipot√©tico $R^*_t$ representa a varia√ß√£o no valor do portf√≥lio se as posi√ß√µes fossem mantidas fixas no tempo $t-1$.
II. Para cada ativo $i$, o retorno de $t-1$ para $t$, $r_{i,t}$, √© aplicado ao peso do ativo no tempo $t-1$, $w_{i, t-1}$.
III. Somando o retorno ponderado de todos os ativos, obtemos o retorno hipot√©tico do portf√≥lio.  ‚ñ†

> üí° **Exemplo Num√©rico:** Continuando com o exemplo anterior, suponha que o valor total do portf√≥lio no final do dia t-1 era de R\$ 10.000, sendo R\$ 6.000 em PETR4 (60%) e R\$ 4.000 em VALE3 (40%). No dia t, PETR4 teve um retorno de 2% e VALE3 de 3%.
>
> Ent√£o, $w_{PETR4, t-1} = 0.6$ e $w_{VALE3, t-1} = 0.4$.
>
> O retorno hipot√©tico seria: $R^*_t = (0.6 * 0.02) + (0.4 * 0.03) = 0.012 + 0.012 = 0.024$, ou seja, 2.4%.
>
> Isso significa que, se as posi√ß√µes fossem mantidas inalteradas, o portf√≥lio teria rendido 2.4% devido √†s varia√ß√µes de mercado dos ativos.

**Lema 2.3:** *Se assumirmos que os pesos $w_{i,t-1}$ s√£o constantes dentro de um dia, o retorno hipot√©tico $R^*_t$ pode ser interpretado como uma m√©dia ponderada dos retornos dos ativos, onde os pesos s√£o os alocados no dia anterior, ou seja, $R^*_t = \sum_{i=1}^{n} w_{i, t-1} r_{i,t}$.*

*Proof:*
I. O Lema 2.2 estabeleceu que o retorno hipot√©tico √© calculado usando os pesos do portf√≥lio no final do dia anterior, $w_{i, t-1}$, e os retornos dos ativos $r_{i,t}$ no dia atual.
II. Esta defini√ß√£o implica que o retorno hipot√©tico √© uma m√©dia ponderada dos retornos dos ativos, utilizando os pesos do dia anterior como pesos.  ‚ñ†

**Retornos *Cleaned*:** Em alguns casos, pode-se utilizar uma aproxima√ß√£o do retorno hipot√©tico, o **retorno *cleaned***, que √© calculado subtraindo do retorno real os itens *non-mark-to-market*, como taxas, comiss√µes e juros l√≠quidos [^4]. Embora o retorno *cleaned* n√£o elimine o efeito da negocia√ß√£o intradi√°ria, ele remove alguns componentes que podem distorcer a avalia√ß√£o do modelo, oferecendo uma alternativa vi√°vel. A escolha entre retornos hipot√©ticos e *cleaned* depende do contexto espec√≠fico e dos objetivos da an√°lise, como estabelecido no texto [^4].

> üí° **Exemplo Num√©rico:** Considere um portf√≥lio que teve um retorno real de 1.5% em um dia. As taxas de corretagem foram de 0.1% e os juros l√≠quidos recebidos foram de 0.2%.
>
> O retorno *cleaned* seria: 1.5% - 0.1% + 0.2% = 1.6%. Note que o retorno cleaned removeu as taxas mas n√£o o impacto das negocia√ß√µes intraday.
>
> Se o retorno hipot√©tico calculado fosse 1.4%, podemos observar as diferen√ßas. O retorno real de 1.5% √© impactado pelas negocia√ß√µes e taxas. O retorno *cleaned* remove as taxas, e o retorno hipot√©tico remove as negocia√ß√µes. Comparando os tr√™s retornos, podemos avaliar o impacto de cada um dos fatores.

**Teorema 2:** *A diferen√ßa entre backtesting com retornos reais e hipot√©ticos revela a influ√™ncia da negocia√ß√£o intradi√°ria e itens non-mark-to-market na performance do portf√≥lio.*

*Proof:*
I. Se o modelo passa no backtesting com retornos hipot√©ticos, indica que o modelo captura adequadamente o risco de mercado para posi√ß√µes fixas.
II. Se o modelo falha no backtesting com retornos reais, isso implica que as mudan√ßas no portf√≥lio (negocia√ß√£o intraday) e itens non-mark-to-market introduzem uma varia√ß√£o que o modelo n√£o est√° capturando.
III. A diferen√ßa entre os resultados de backtesting com retornos reais e hipot√©ticos pode ser utilizada para isolar o impacto desses fatores na performance do portf√≥lio. ‚ñ†

**Corol√°rio 2.1:** *Se um modelo VAR passa no backtesting com retornos hipot√©ticos, mas n√£o com retornos reais, isso sugere que a atividade de negocia√ß√£o intradi√°ria ou fatores non-mark-to-market podem estar contribuindo para o aumento das perdas, e o processo de backtesting precisa de avalia√ß√£o cuidadosa para isolar a fonte dos problemas.*

O corol√°rio 2.1 enfatiza que a falha do modelo VAR com retornos reais, em contraste com o sucesso com retornos hipot√©ticos, serve como um sinal de alerta, indicando que aspectos do processo de negocia√ß√£o ou itens n√£o considerados podem ser a causa da discrep√¢ncia, requerendo aten√ß√£o dos gestores de risco.

**Teorema 2.1:** *Seja $R_t$ o retorno real e $R^*_t$ o retorno hipot√©tico no tempo $t$. A diferen√ßa $D_t = R_t - R^*_t$ representa o efeito da negocia√ß√£o intradi√°ria e dos itens non-mark-to-market sobre o retorno do portf√≥lio no dia $t$. O ac√∫mulo dessas diferen√ßas, $\sum_{t=1}^{T} D_t$, ao longo do per√≠odo de backtesting, indica o impacto cumulativo dessas atividades na performance do portf√≥lio.*

*Proof:*
I. Pela defini√ß√£o, $R_t$ inclui o efeito da negocia√ß√£o intradi√°ria e itens n√£o *mark-to-market*, enquanto $R^*_t$ n√£o.
II. Portanto, a diferen√ßa $D_t$ isola o efeito dessas atividades no dia $t$.
III. Ao somar essas diferen√ßas ao longo do tempo, $\sum_{t=1}^{T} D_t$, obtemos uma medida do efeito cumulativo desses fatores durante todo o per√≠odo de backtesting.
IV. Esta soma permite avaliar o quanto a negocia√ß√£o intradi√°ria e os itens n√£o *mark-to-market* contribu√≠ram, positiva ou negativamente, para o resultado final do portf√≥lio.  ‚ñ†

> üí° **Exemplo Num√©rico:** Considere um per√≠odo de backtesting de 5 dias. Os retornos reais ($R_t$), hipot√©ticos ($R^*_t$) e as diferen√ßas ($D_t = R_t - R^*_t$) s√£o mostrados na tabela abaixo:
>
> | Dia (t) | Retorno Real ($R_t$) | Retorno Hipot√©tico ($R^*_t$) | Diferen√ßa ($D_t$) |
> |---------|----------------------|---------------------------|-----------------|
> | 1       | 0.015                | 0.012                     | 0.003           |
> | 2       | -0.008               | -0.010                    | 0.002           |
> | 3       | 0.020                | 0.018                     | 0.002           |
> | 4       | -0.005               | -0.003                    | -0.002          |
> | 5       | 0.010                | 0.009                     | 0.001           |
>
> O impacto cumulativo ao longo do per√≠odo de backtesting seria a soma das diferen√ßas:
>
> $\sum_{t=1}^{5} D_t = 0.003 + 0.002 + 0.002 - 0.002 + 0.001 = 0.006$ ou 0.6%.
>
> Isso indica que, ao longo desses 5 dias, a negocia√ß√£o intradi√°ria e os itens n√£o *mark-to-market* contribu√≠ram com um adicional de 0.6% ao retorno do portf√≥lio em rela√ß√£o ao que seria esperado se as posi√ß√µes tivessem sido mantidas fixas.

**Teorema 2.2:** *Se a s√©rie temporal de diferen√ßas $D_t = R_t - R^*_t$ mostrar padr√µes sistem√°ticos ou autocorrela√ß√£o, isso pode indicar a presen√ßa de vieses nas estrat√©gias de negocia√ß√£o intraday ou na contabiliza√ß√£o de itens non-mark-to-market que precisam ser investigados.*

*Proof:*
I. Se $D_t$ for puramente aleat√≥rio, sem padr√µes ou autocorrela√ß√£o, indica que os efeitos da negocia√ß√£o intraday e itens non-mark-to-market s√£o aleat√≥rios e n√£o enviesados.
II. No entanto, a presen√ßa de padr√µes ou autocorrela√ß√£o em $D_t$ indica que os resultados da negocia√ß√£o intraday est√£o correlacionados ao longo do tempo, sugerindo que a performance pode ser influenciada por um vi√©s.
III. A an√°lise de autocorrela√ß√£o de $D_t$ pode revelar o per√≠odo e a natureza deste vi√©s.
IV. A identifica√ß√£o de padr√µes em $D_t$ pode ajudar a ajustar as pr√°ticas de negocia√ß√£o e melhorar a precis√£o do backtesting e da gest√£o de riscos.  ‚ñ†

> üí° **Exemplo Num√©rico:** Continuando com os dados da tabela anterior, podemos calcular a autocorrela√ß√£o da s√©rie $D_t$. Vamos calcular a autocorrela√ß√£o de primeira ordem (lag 1). A s√©rie $D_t$ √© [0.003, 0.002, 0.002, -0.002, 0.001].
>
> 1.  **M√©dia de $D_t$:**
> $\bar{D} = \frac{0.003 + 0.002 + 0.002 - 0.002 + 0.001}{5} = 0.0012$
>
> 2.  **Desvio padr√£o de $D_t$:**
> Para simplificar, n√£o vamos calcular o desvio padr√£o nesse exemplo. Vamos prosseguir diretamente com a autocorrela√ß√£o.
>
> 3. **S√©rie $D_{t-1}$:**
> A s√©rie $D_{t-1}$ (com lag 1) √© [NaN, 0.003, 0.002, 0.002, -0.002].
>
> 4. **Covari√¢ncia entre $D_t$ e $D_{t-1}$:**
>  $\text{Cov}(D_t, D_{t-1}) = \frac{1}{N-1} \sum_{t=2}^{N} (D_t - \bar{D})(D_{t-1} - \bar{D}) $
>
>  $\text{Cov}(D_t, D_{t-1}) = \frac{1}{4} [ (0.002 - 0.0012)(0.003 - 0.0012) + (0.002 - 0.0012)(0.002 - 0.0012) + (-0.002 - 0.0012)(0.002 - 0.0012) + (0.001-0.0012)(-0.002 - 0.0012) ]$
>
>  $\text{Cov}(D_t, D_{t-1}) = \frac{1}{4} [(0.0008)(0.0018) + (0.0008)(0.0008) + (-0.0032)(0.0008) + (-0.0002)(-0.0032)]  = \frac{1}{4}[0.00000144 + 0.00000064 - 0.00000256 + 0.000000064] = -0.000000104$
>
> 5. **Autocorrela√ß√£o de primeira ordem (lag 1):**
> Para simplificar, vamos assumir um desvio padr√£o de aproximadamente 0.002 para a s√©rie de diferen√ßas $D_t$. Ent√£o,
> $\text{Autocorr}(D_t, D_{t-1}) = \frac{\text{Cov}(D_t, D_{t-1})}{\text{Var}(D_t)}$
> $\text{Autocorr}(D_t, D_{t-1}) = \frac{-0.000000104}{0.002^2} = \frac{-0.000000104}{0.000004} \approx -0.026$
>
> Um valor pr√≥ximo a zero como -0.026 sugere que n√£o h√° uma forte autocorrela√ß√£o de primeira ordem. No entanto, em uma s√©rie temporal maior e com outros lags, poder√≠amos detectar padr√µes significativos. Se a autocorrela√ß√£o fosse significativamente diferente de zero em algum lag, isso indicaria que as diferen√ßas ($D_t$) n√£o s√£o puramente aleat√≥rias, sugerindo vieses nas opera√ß√µes de trading intraday ou na contabiliza√ß√£o de itens *non-mark-to-market*.

**Observa√ß√£o 2.1:** *A an√°lise da distribui√ß√£o da s√©rie temporal $D_t = R_t - R^*_t$ pode tamb√©m fornecer insights adicionais sobre o comportamento dos retornos. Se a distribui√ß√£o de $D_t$ for significativamente n√£o-normal, isso pode indicar que os efeitos da negocia√ß√£o intraday e itens non-mark-to-market s√£o complexos e n√£o capturados por medidas de risco tradicionais, justificando uma modelagem mais sofisticada desses efeitos.*

Esta observa√ß√£o complementa o Teorema 2.2, indicando que, al√©m de buscar autocorrela√ß√£o, devemos analisar a distribui√ß√£o da diferen√ßa entre retornos reais e hipot√©ticos para compreender melhor a natureza dos impactos da negocia√ß√£o intraday e de itens n√£o *mark-to-market*.

> üí° **Exemplo Num√©rico:** Suponha que, ap√≥s analisar uma longa s√©rie temporal de $D_t$, observemos que sua distribui√ß√£o tem caudas mais pesadas do que uma distribui√ß√£o normal e uma assimetria negativa. Isso sugere que:
>
> *   **Caudas pesadas:** A ocorr√™ncia de diferen√ßas extremas entre retornos reais e hipot√©ticos √© mais frequente do que seria esperado em uma distribui√ß√£o normal, indicando que os impactos da negocia√ß√£o intraday e itens *non-mark-to-market* podem gerar perdas ou ganhos inesperadamente grandes.
> *   **Assimetria negativa:** As perdas devido √† negocia√ß√£o intraday e itens n√£o *mark-to-market* tendem a ser maiores do que os ganhos correspondentes, o que pode indicar que o portf√≥lio est√° mais vulner√°vel a esses fatores quando o mercado se move em dire√ß√µes desfavor√°veis.
>
> Essa an√°lise nos leva a concluir que a distribui√ß√£o n√£o normal de $D_t$ √© uma evid√™ncia de que uma modelagem mais avan√ßada, que leve em considera√ß√£o a assimetria e as caudas pesadas, √© necess√°ria para uma avalia√ß√£o mais precisa do risco.

**A import√¢ncia da compara√ß√£o:** A compara√ß√£o entre os resultados do *backtesting* utilizando retornos reais e hipot√©ticos fornece uma vis√£o mais completa do desempenho do modelo VAR [^4]. Se um modelo √© validado com retornos hipot√©ticos, mas n√£o com retornos reais, a aten√ß√£o deve se voltar para a din√¢mica de negocia√ß√£o intradi√°ria e itens *non-mark-to-market*.

### Conclus√£o
Em suma, a distin√ß√£o entre retornos reais e hipot√©ticos √© crucial para o *backtesting* eficaz de modelos VAR, e o uso de retornos *cleaned* pode ajudar a isolar os fatores que impactam a performance [^4]. O retorno hipot√©tico permite avaliar a precis√£o do modelo em capturar o risco de mercado, enquanto o retorno real reflete o resultado financeiro efetivo das opera√ß√µes, complementando a discuss√£o sobre a avalia√ß√£o de modelos por meio da an√°lise da distribui√ß√£o de exce√ß√µes. Ao analisar ambos os retornos, os gestores de risco podem obter uma compreens√£o mais clara de onde reside o problema, seja na calibra√ß√£o do modelo, nas estrat√©gias de negocia√ß√£o ou na influ√™ncia de itens *non-mark-to-market*. Esta an√°lise detalhada possibilita identificar pontos de melhoria no modelo e nas pr√°ticas de gest√£o de risco, garantindo a efic√°cia do sistema VAR e a conformidade com os requisitos regulat√≥rios [^1]. O processo de backtesting, como visto, deve ser implementado como uma pr√°tica cont√≠nua para assegurar que o modelo VAR esteja sempre alinhado com os riscos de mercado.

### Refer√™ncias
[^1]: *This chapter turns to backtesting techniques for verifying the accuracy of VAR models. Backtesting is a formal statistical framework that consists of verifying that actual losses are in line with projected losses.*
[^2]: *When the model is perfectly calibrated, the number of observations falling outside VAR should be in line with the confidence level.*
[^3]: *For verification to be meaningful, the risk manager should track both the actual portfolio return R, and the hypothetical return R* that most closely matches the VAR forecast.*
[^4]: *Since the VAR forecast really pertains to R*, backtesting ideally should be done with these hypothetical returns.*
<!-- END -->
