## Backtesting VAR Models: Core Principles and Validation

<img src="C:\Users\diego.rodrigues\Documents\Risk Analysis\01. Value at Risk Models\02. Backtesting VaR\02. Backtesting Fundamentals\_files\8110bc5bb11f518b8c427c07aa18661ed4df2a128cc95e0676e3563d6830aa96.jpg" alt="8110bc5bb11f518b8c427c07aa18661ed4df2a128cc95e0676e3563d6830aa96" style="zoom: 25%;" />

### Introdu√ß√£o

Como discutido anteriormente, os modelos de Value-at-Risk (VAR) s√£o ferramentas essenciais na an√°lise de risco financeiro, mas sua utilidade depende da precis√£o com que preveem o risco [^1]. Para garantir essa precis√£o, √© fundamental realizar a valida√ß√£o do modelo, que engloba um conjunto de ferramentas, incluindo o *backtesting*, testes de estresse e revis√£o independente [^1]. Este cap√≠tulo foca especificamente nas t√©cnicas de *backtesting* para verificar a acur√°cia dos modelos VAR, com √™nfase na compara√ß√£o sistem√°tica entre as previs√µes VAR e os retornos de portf√≥lio associados.

### Conceitos Fundamentais
O *backtesting* √© um framework estat√≠stico formal que visa verificar se as perdas reais est√£o de acordo com as perdas projetadas por um modelo VAR [^1]. O processo envolve comparar sistematicamente o hist√≥rico de previs√µes VAR com os retornos do portf√≥lio correspondentes [^1]. Esses procedimentos, tamb√©m chamados de " *reality checks* ", s√£o cruciais para que usu√°rios de VAR e gestores de risco assegurem a calibra√ß√£o correta de suas previs√µes. Caso contr√°rio, os modelos devem ser revisados em busca de premissas defeituosas, par√¢metros incorretos ou modelagem imprecisa [^1].

**A Import√¢ncia da Calibra√ß√£o:**
==Quando um modelo est√° perfeitamente calibrado, o n√∫mero de observa√ß√µes que ficam fora do VAR deve estar alinhado com o n√≠vel de confian√ßa estabelecido [^2]. O n√∫mero de exced√™ncias, tamb√©m conhecido como n√∫mero de exce√ß√µes, √© um indicador fundamental da precis√£o do modelo [^2]. Excesso de exce√ß√µes sugere que o modelo subestima o risco, o que pode levar √† aloca√ß√£o insuficiente de capital. Por outro lado, poucas exce√ß√µes podem resultar na aloca√ß√£o excessiva de capital [^2].==
Como descrito no texto, o core do *backtesting* √© a compara√ß√£o entre os n√≠veis de perdas previstos pelo modelo VAR e os n√≠veis de perdas reais observados [^2]. O objetivo √© verificar se o n√∫mero de exce√ß√µes, ou seja, as inst√¢ncias em que as perdas reais excedem o VAR previsto, est√° em conformidade com o n√≠vel de confian√ßa do modelo [^2].

**Setup para Backtesting:**
Para realizar o *backtesting* de forma eficaz, os usu√°rios devem verificar sistematicamente a validade dos modelos de risco e avalia√ß√£o subjacentes, comparando os n√≠veis de perda previstos e reais [^2]. √â importante notar que o conceito de *exce√ß√£o* √© central para a valida√ß√£o de modelos.
A avalia√ß√£o da calibra√ß√£o de um modelo pode ser visualizada atrav√©s de um gr√°fico que compara o valor absoluto do lucro e perda (P&L) di√°rio com o VAR di√°rio [^2]. Observa√ß√µes acima da linha diagonal indicam dias em que o valor absoluto do P&L excedeu o VAR [^3]. Em um modelo bem calibrado, o n√∫mero de exce√ß√µes deve ser consistente com o n√≠vel de confian√ßa do VAR [^3].

> üí° **Exemplo Num√©rico:** Suponha que um modelo VAR de um dia com um n√≠vel de confian√ßa de 99% √© usado. Isso significa que, em m√©dia, esperamos que o P&L exceda o VAR uma vez a cada 100 dias. Se observarmos o P&L di√°rio durante 250 dias e plotarmos o valor absoluto do P&L junto com o VAR di√°rio, podemos visualizar as exce√ß√µes. Um modelo bem calibrado teria aproximadamente 2.5 exce√ß√µes (250 * (1 - 0.99)). Se visualizarmos 7 exce√ß√µes, isso sugere que o modelo pode estar subestimando o risco.
> ```mermaid
> graph LR
>     A[Dias] --> B(P&L Absoluto);
>     A --> C(VAR Di√°rio);
>     B --> D{P&L > VAR?};
>     D -- Yes --> E[Exce√ß√£o];
>     D -- No --> F[Sem Exce√ß√£o];
> ```

**Lema 1:** *Sob a hip√≥tese de que os retornos do portf√≥lio s√£o independentes e identicamente distribu√≠dos (i.i.d.) e que o modelo VAR √© bem especificado, o n√∫mero de exce√ß√µes deve seguir uma distribui√ß√£o binomial.*

*Proof:*
I. Seja $X_i$ uma vari√°vel aleat√≥ria indicadora que assume valor 1 se houver uma exce√ß√£o no dia $i$ e 0 caso contr√°rio.
II. Dado que o modelo VAR √© bem calibrado com n√≠vel de confian√ßa $\alpha$, a probabilidade de uma exce√ß√£o em um dia √© $P(X_i = 1) = 1 - \alpha$.
III. Se os retornos s√£o i.i.d., ent√£o as vari√°veis indicadoras $X_i$ s√£o independentes e identicamente distribu√≠das.
IV. Seja $Y$ o n√∫mero total de exce√ß√µes em $N$ dias, ent√£o $Y = \sum_{i=1}^{N} X_i$.
V. A soma de vari√°veis aleat√≥rias independentes de Bernoulli, com a mesma probabilidade de sucesso, segue uma distribui√ß√£o binomial.
VI. Portanto, o n√∫mero de exce√ß√µes $Y$ segue uma distribui√ß√£o binomial com par√¢metros $N$ e $1 - \alpha$, denotada como $Y \sim \text{Binomial}(N, 1-\alpha)$. ‚ñ†

**Proposi√ß√£o 1:** *A distribui√ß√£o binomial do n√∫mero de exce√ß√µes, sob as hip√≥teses do Lema 1, permite calcular intervalos de confian√ßa para o n√∫mero de exce√ß√µes esperadas, possibilitando uma avalia√ß√£o mais precisa da calibra√ß√£o do modelo VAR.*

*Proof:*
I. Do Lema 1, o n√∫mero de exce√ß√µes $Y$ segue uma distribui√ß√£o binomial $Y \sim \text{Binomial}(N, 1 - \alpha)$.
II. O valor esperado do n√∫mero de exce√ß√µes √© $E[Y] = N(1 - \alpha)$.
III. A vari√¢ncia do n√∫mero de exce√ß√µes √© $Var(Y) = N(1 - \alpha)\alpha$.
IV. O desvio padr√£o do n√∫mero de exce√ß√µes √© $\sigma_Y = \sqrt{N(1 - \alpha)\alpha}$.
V. Usando a distribui√ß√£o binomial, ou aproximando com uma distribui√ß√£o normal para $N$ grande, podemos construir intervalos de confian√ßa para $Y$.
VI. Um intervalo de confian√ßa de 95%, por exemplo, √© aproximadamente dado por $[N(1 - \alpha) - 1.96\sqrt{N(1 - \alpha)\alpha}, N(1 - \alpha) + 1.96\sqrt{N(1 - \alpha)\alpha}]$.
VII. Se o n√∫mero real de exce√ß√µes estiver dentro desse intervalo, o modelo √© considerado bem calibrado com um n√≠vel de confian√ßa de 95%. ‚ñ†

> üí° **Exemplo Num√©rico:** Considere um modelo VAR com um n√≠vel de confian√ßa de 99% ($\alpha = 0.99$) aplicado a 250 dias de dados ($N = 250$).
>
> - O n√∫mero esperado de exce√ß√µes √© $E[Y] = 250 * (1 - 0.99) = 2.5$.
> - A vari√¢ncia do n√∫mero de exce√ß√µes √© $Var(Y) = 250 * (1 - 0.99) * 0.99 = 2.475$.
> - O desvio padr√£o do n√∫mero de exce√ß√µes √© $\sigma_Y = \sqrt{2.475} \approx 1.57$.
> - Um intervalo de confian√ßa de 95% para o n√∫mero de exce√ß√µes √© aproximadamente $[2.5 - 1.96*1.57, 2.5 + 1.96*1.57] \approx [-0.58, 5.58]$. Como o n√∫mero de exce√ß√µes n√£o pode ser negativo, usamos [0, 5.58], arredondando para [0, 6] exce√ß√µes.
>
> Portanto, se observarmos, por exemplo, 5 exce√ß√µes em 250 dias, o modelo estaria dentro do intervalo de confian√ßa, e poder√≠amos concluir que est√° bem calibrado com 95% de confian√ßa.

**Proposi√ß√£o 1.1:** *Al√©m dos intervalos de confian√ßa, o teste de hip√≥tese binomial pode ser usado para avaliar formalmente se o n√∫mero de exce√ß√µes observadas difere significativamente do n√∫mero esperado, sob as premissas de um modelo bem calibrado e retornos i.i.d.*

*Proof:*
I. Formule a hip√≥tese nula $H_0$ de que o modelo VAR est√° bem calibrado, ou seja, a probabilidade de uma exce√ß√£o √© $1-\alpha$.
II. Formule a hip√≥tese alternativa $H_1$ de que o modelo VAR n√£o est√° bem calibrado, ou seja, a probabilidade de uma exce√ß√£o √© diferente de $1-\alpha$.
III. Seja $k$ o n√∫mero de exce√ß√µes observadas em $N$ dias.
IV. Calcule o p-valor, que √© a probabilidade de observar $k$ ou mais exce√ß√µes (se $k > N(1-\alpha)$) ou $k$ ou menos exce√ß√µes (se $k < N(1-\alpha)$), assumindo que $H_0$ √© verdadeira.
V. O p-valor √© calculado como a soma das probabilidades da distribui√ß√£o binomial em torno de k: $p-valor = P(Y \ge k | H_0) \text{ se } k > N(1 - \alpha) \text{ ou } p-valor = P(Y \le k | H_0) \text{ se } k < N(1 - \alpha)$.
VI. Se o p-valor for menor que um n√≠vel de signific√¢ncia pr√©-definido (por exemplo, 5%), rejeitamos $H_0$ e conclu√≠mos que o modelo n√£o est√° bem calibrado. ‚ñ†

> üí° **Exemplo Num√©rico:** Usando o mesmo cen√°rio anterior (VAR 99%, 250 dias), se observamos 7 exce√ß√µes ($k=7$), queremos testar se isso √© estatisticamente significativo.
>
> - $H_0$: O modelo VAR est√° bem calibrado (probabilidade de exce√ß√£o = 0.01)
> - $H_1$: O modelo VAR n√£o est√° bem calibrado (probabilidade de exce√ß√£o != 0.01)
>
> Podemos usar um teste binomial unilateral direito (pois temos mais exce√ß√µes do que o esperado) ou bilateral, para maior generalidade. Em um teste binomial bilateral, calculamos:
> $$
> p-valor = P(Y \ge 7 | N=250, p=0.01) + P(Y \le x | N=250, p=0.01)
> $$
> onde $x$ √© o n√∫mero de exce√ß√µes tal que $P(Y \le x | N=250, p=0.01) \approx P(Y \ge 7 | N=250, p=0.01)$. Usando um software estat√≠stico ou calculando diretamente as probabilidades da distribui√ß√£o binomial, encontramos:
>
> $P(Y \ge 7 | N=250, p=0.01) \approx 0.0041$
>
> $P(Y \le 0 | N=250, p=0.01) \approx 0.081$ (note que $P(Y=0)$ √© a maior probabilidade que temos do lado esquerdo, que √© inferior a 0.01). Calculamos o p-valor bilateral considerando as probabilidades em ambos os lados que sejam menores ou iguais √† do nosso valor observado, o que seria a probabilidade de observar 7 ou mais exce√ß√µes e a probabilidade de observar 0 ou menos exce√ß√µes.
>
> Vamos calcular as probabilidades at√© encontrarmos uma que seja menor ou igual a 0.0041.
>
> $P(Y=0) \approx 0.0810$
> $P(Y=1) \approx 0.2048$
> $P(Y=2) \approx 0.2583$
> $P(Y=3) \approx 0.2150$
> $P(Y=4) \approx 0.1348$
> $P(Y=5) \approx 0.0666$
> $P(Y=6) \approx 0.0219$
>
> Assim, somamos as probabilidades de 0 e 7 ou mais exce√ß√µes, $p-valor \approx 0.0041 + 0.0810 \approx 0.085$.
> Se usarmos um n√≠vel de signific√¢ncia de 5%, como $0.085 > 0.05$, n√£o rejeitamos $H_0$, e conclu√≠mos que o modelo √© bem calibrado.

**Considera√ß√µes sobre Retorno:**
Uma quest√£o importante no *backtesting* √© a escolha do retorno a ser utilizado na compara√ß√£o. Os modelos VAR assumem que o portf√≥lio permanece "congelado" ao longo do horizonte de tempo [^3]. No entanto, na pr√°tica, o portf√≥lio de negocia√ß√£o evolui dinamicamente, "contaminando" o retorno real com mudan√ßas em sua composi√ß√£o. Portanto, √© crucial utilizar o retorno hipot√©tico, que corresponde a um portf√≥lio congelado, para realizar o *backtesting* [^4]. O retorno hipot√©tico, $R^*$,  √© obtido aplicando posi√ß√µes fixas aos retornos reais de todos os ativos, medidos de fechamento a fechamento [^4]. Tamb√©m pode-se usar um retorno *cleaned*, que √© o retorno real menos os itens *non-mark-to-market*, como taxas e comiss√µes [^4]. Idealmente, ambos os retornos reais e hipot√©ticos devem ser usados para *backtesting*, pois eles oferecem perspectivas diferentes. Se um modelo passa no *backtesting* com retornos hipot√©ticos, mas n√£o com retornos reais, o problema pode estar na negocia√ß√£o intradi√°ria [^4].

> üí° **Exemplo Num√©rico:** Suponha que um portf√≥lio tenha apenas dois ativos, A e B. As posi√ß√µes no fechamento do dia $t-1$ s√£o 100 a√ß√µes de A e 50 a√ß√µes de B. No dia $t$, os pre√ßos de A e B variam, e as posi√ß√µes mudam devido a opera√ß√µes intradi√°rias.
>
> - Retorno real ($R$): o retorno obtido pelo portf√≥lio, considerando todas as mudan√ßas de posi√ß√£o e os retornos dos ativos.
> - Retorno hipot√©tico ($R^*$) : o retorno que o portf√≥lio teria obtido se as posi√ß√µes tivessem sido mantidas constantes desde o dia anterior (100 a√ß√µes de A e 50 a√ß√µes de B), multiplicado pelos retornos di√°rios.
>
> Para calcular o retorno hipot√©tico, primeiro calculamos os retornos di√°rios dos ativos A e B, $r_A$ e $r_B$ respectivamente. Se no dia $t$ o pre√ßo de A mudou 2% e B mudou -1%, $r_A=0.02$ e $r_B=-0.01$. Se o valor do portf√≥lio no fechamento do dia $t-1$ era 1000$, ent√£o o retorno hipot√©tico, $R^*$, √© dado por:
> $$
> R^* =  (100 \times r_A \times P_{A, t-1} + 50 \times r_B \times P_{B, t-1}) / 1000
> $$
> onde $P_{A,t-1}$ e $P_{B, t-1}$ s√£o os pre√ßos dos ativos A e B no dia t-1.
>
> Vamos supor que os pre√ßos de A e B no dia $t-1$ eram de 5 e 10, respectivamente.
> $$
> R^* = (100 \times 0.02 \times 5 + 50 \times -0.01 \times 10) / (100 \times 5 + 50 \times 10) = (10 - 5) / 1000 = 0.005
> $$
> Assim, o retorno hipot√©tico √© de 0.5%.
>
> Se o retorno real fosse de 0.3%, a diferen√ßa pode ser atribu√≠da √† negocia√ß√£o intradi√°ria ou itens n√£o-mark-to-market.

**Teorema 1:** *Se um modelo VAR passa no backtesting com retornos hipot√©ticos mas falha com retornos reais, ent√£o a fonte da discrep√¢ncia √© a atividade de negocia√ß√£o intradi√°ria e/ou itens n√£o-mark-to-market.*

*Proof:*
I. O retorno hipot√©tico $R^*$ calcula os retornos como se as posi√ß√µes do portf√≥lio tivessem sido mantidas constantes durante o dia.
II. O retorno real $R$ reflete as mudan√ßas no portf√≥lio devido √† negocia√ß√£o intradi√°ria e fatores como taxas e comiss√µes.
III. Se o modelo VAR passa no backtesting com $R^*$ mas falha com $R$, significa que o VAR est√° bem calibrado para um portf√≥lio est√°tico.
IV. A falha com o retorno real √© resultado da diferen√ßa entre um portf√≥lio est√°tico (retorno hipot√©tico) e um din√¢mico (retorno real), que √© atribu√≠vel √† negocia√ß√£o intradi√°ria e/ou itens non-mark-to-market. ‚ñ†

**Corol√°rio 1.1:** *O uso de retornos hipot√©ticos √© uma ferramenta eficaz para isolar a precis√£o do modelo VAR, independente das mudan√ßas de posi√ß√£o.*

Este corol√°rio destaca a import√¢ncia dos retornos hipot√©ticos para o backtesting, uma vez que eles oferecem uma base comparativa que elimina a influ√™ncia de altera√ß√µes na composi√ß√£o do portf√≥lio.

**Lema 1.1:** *Se os retornos do portf√≥lio n√£o forem i.i.d. ou o modelo VAR n√£o estiver bem especificado, a distribui√ß√£o do n√∫mero de exce√ß√µes pode n√£o ser binomial.*

*Proof:*
I. A prova do Lema 1 estabelece que o n√∫mero de exce√ß√µes segue uma distribui√ß√£o binomial sob as hip√≥teses de retornos i.i.d. e modelo VAR bem especificado.
II. Se os retornos n√£o forem i.i.d., a independ√™ncia e identidade da distribui√ß√£o de $X_i$ n√£o s√£o garantidas.
III. A falta de independ√™ncia pode ser devido a depend√™ncia temporal (por exemplo, volatilidade agrupada) ou outras formas de correla√ß√£o.
IV. Se o modelo VAR n√£o estiver bem especificado, a probabilidade de uma exce√ß√£o n√£o √© constante e igual a $1 - \alpha$.
V. Portanto, sob essas viola√ß√µes, a distribui√ß√£o do n√∫mero de exce√ß√µes n√£o ser√° binomial. ‚ñ†

**Lema 1.2:** *A depend√™ncia temporal nos retornos, como a presen√ßa de volatilidade agrupada, pode levar a um n√∫mero de exce√ß√µes maior ou menor do que o esperado sob a hip√≥tese de retornos i.i.d.*

*Proof:*
I. Volatilidade agrupada significa que per√≠odos de alta volatilidade s√£o seguidos por outros per√≠odos de alta volatilidade, e da mesma forma para per√≠odos de baixa volatilidade.
II. Se um per√≠odo de alta volatilidade ocorre, o modelo VAR pode ser subestimado, levando a um n√∫mero maior de exce√ß√µes do que o esperado sob a hip√≥tese i.i.d.
III. Analogamente, em per√≠odos de baixa volatilidade, o VAR pode ser superestimado, levando a menos exce√ß√µes do que o esperado sob a hip√≥tese i.i.d.
IV. Portanto, a presen√ßa de volatilidade agrupada faz com que o n√∫mero de exce√ß√µes se desvie do esperado sob uma distribui√ß√£o binomial, violando a premissa de retornos i.i.d. ‚ñ†

> üí° **Exemplo Num√©rico:** Considere um per√≠odo de alta volatilidade que n√£o √© capturado por um modelo VAR que assume retornos i.i.d. Se o modelo prev√™ um VAR de \$ 100.000, mas as perdas reais em v√°rios dias seguidos durante essa alta volatilidade superam \$ 150.000, haver√° um n√∫mero excessivo de exce√ß√µes durante esse per√≠odo, demonstrando a inadequa√ß√£o do modelo. Modelos que consideram a volatilidade agrupada, como GARCH, poderiam se ajustar melhor a esse cen√°rio.

**Teorema 1.1:** *A rejei√ß√£o do modelo VAR baseado no backtesting com retornos hipot√©ticos implica que o modelo est√° mal calibrado ou com premissas defeituosas.*

*Proof:*
I. O retorno hipot√©tico isola a precis√£o do modelo VAR das mudan√ßas na composi√ß√£o do portf√≥lio.
II. Se o modelo falha no backtesting com retornos hipot√©ticos, isso significa que as perdas reais s√£o maiores do que as previstas, mesmo com um portf√≥lio constante.
III. A falha n√£o pode ser atribu√≠da √† negocia√ß√£o intradi√°ria ou itens n√£o-mark-to-market.
IV. Portanto, a falha √© inerente ao modelo, que ou est√° mal calibrado (par√¢metros incorretos) ou possui premissas defeituosas (por exemplo, suposi√ß√µes incorretas sobre a distribui√ß√£o de retornos). ‚ñ†

**Teorema 1.2:** *A falha no backtesting devido a depend√™ncia temporal pode ser mitigada usando modelos VAR que levam em considera√ß√£o a volatilidade condicional, como modelos GARCH.*

*Proof:*
I. Modelos GARCH incorporam volatilidade condicional, que √© a varia√ß√£o na volatilidade ao longo do tempo.
II. Modelos GARCH ajustam o VAR de acordo com as mudan√ßas recentes na volatilidade.
III. A presen√ßa de volatilidade agrupada viola a premissa de independ√™ncia dos retornos, levando a backtesting ruim.
IV. Ao usar modelos GARCH, o VAR ajusta-se dinamicamente √† volatilidade atual, reduzindo a probabilidade de exce√ß√µes inesperadas e melhorando o desempenho do backtesting. ‚ñ†

**Observa√ß√£o 1:** *A escolha do tamanho da amostra (n√∫mero de dias de backtesting) impacta a precis√£o da avalia√ß√£o.* Amostras maiores oferecem maior poder estat√≠stico para identificar modelos mal calibrados, mas o custo computacional e a disponibilidade de dados podem ser um limitador.

**Observa√ß√£o 2:** *O per√≠odo de tempo coberto pelo backtesting tamb√©m √© importante. Periodos de alta volatilidade ou crises podem levar a um n√∫mero maior de exce√ß√µes, mesmo para um modelo bem calibrado, e √© importante que tais periodos sejam representados adequadamente no backtesting.*

### Conclus√£o
O *backtesting* √©, portanto, uma ferramenta indispens√°vel para garantir a precis√£o dos modelos VAR. Ele permite que gestores de risco identifiquem modelos que subestimam o risco ou que n√£o est√£o corretamente calibrados, fornecendo assim, uma base s√≥lida para a tomada de decis√µes e gest√£o de capital. A correta aplica√ß√£o dessas t√©cnicas contribui para a seguran√ßa e estabilidade do sistema financeiro. As decis√µes sobre a aceita√ß√£o ou rejei√ß√£o de um modelo devem ser feitas em um n√≠vel de confian√ßa estat√≠stico, que √© distinto do n√≠vel quantitativo usado no c√°lculo do VAR [^5]. O *backtesting* √© um processo cont√≠nuo que deve fazer parte integral de todos os sistemas VAR [^1].

### Refer√™ncias
[^1]: *This chapter turns to backtesting techniques for verifying the accuracy of VAR models. Backtesting is a formal statistical framework that consists of verifying that actual losses are in line with projected losses.*
[^2]: *When the model is perfectly calibrated, the number of observations falling outside VAR should be in line with the confidence level.*
[^3]: *Observations that lie above the diagonal line indicate days when the absolute value of the P&L exceeded the VAR.*
[^4]: *For verification to be meaningful, the risk manager should track both the actual portfolio return R, and the hypothetical return R* that most closely matches the VAR forecast.*
[^5]: *At the outset, it should be noted that this decision must be made at some confidence level.*
<!-- END -->
