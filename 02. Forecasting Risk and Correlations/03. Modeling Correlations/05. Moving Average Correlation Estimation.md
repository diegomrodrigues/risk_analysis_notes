### Introdu√ß√£o
Este cap√≠tulo foca-se na modelagem de correla√ß√µes em mercados financeiros, com uma an√°lise detalhada da t√©cnica de m√©dias m√≥veis (MA). Em continuidade √†s abordagens para modelar a volatilidade [^1], exploraremos como a t√©cnica de m√©dias m√≥veis pode ser adaptada para estimar as correla√ß√µes entre ativos financeiros. Analisaremos as vantagens e desvantagens dessa t√©cnica, bem como as implica√ß√µes de seu uso na gest√£o de risco e an√°lise de portf√≥lio [^15].

### Estima√ß√£o de Correla√ß√µes com M√©dias M√≥veis

Assim como na estima√ß√£o de volatilidade, um m√©todo simples para estimar correla√ß√µes √© usar uma janela m√≥vel de comprimento fixo [^15]. Esta abordagem calcula a correla√ß√£o entre dois ativos durante um per√≠odo de tempo espec√≠fico, movendo a janela ao longo do tempo para criar uma s√©rie temporal de estimativas de correla√ß√£o.
![An example of correlations estimations between assets with the moving average technique.](./../images/correlations_estimation_assets_moving_average_technique.png)

#### Formula√ß√£o Matem√°tica
Dado que observamos os retornos $r_{i,t}$ para o ativo $i$ ao longo de um per√≠odo de $M$ dias, a covari√¢ncia condicional estimada usando a m√©dia m√≥vel (MA) √©:

$$
\sigma_{ij,t}^2 = \frac{1}{M} \sum_{k=1}^{M} r_{i,t-k} r_{j,t-k}
$$

Onde:
*   $\sigma_{ij,t}^2$ √© a covari√¢ncia condicional entre os ativos $i$ e $j$ no tempo $t$.
*   $M$ √© o comprimento da janela m√≥vel.
*   $r_{i,t-k}$ e $r_{j,t-k}$ s√£o os retornos dos ativos $i$ e $j$ no tempo $t-k$, respectivamente.

A correla√ß√£o condicional √© ent√£o calculada como:

$$
\rho_{ij,t} = \frac{\sigma_{ij,t}^2}{\sqrt{\sigma_{ii,t}^2 \sigma_{jj,t}^2}}
$$

Onde:
*   $\rho_{ij,t}$ √© a correla√ß√£o condicional entre os ativos $i$ e $j$ no tempo $t$.
*   $\sigma_{ii,t}^2$ e $\sigma_{jj,t}^2$ s√£o as vari√¢ncias dos ativos $i$ e $j$ no tempo $t$, calculadas usando a mesma janela m√≥vel.

> üí° **Exemplo Num√©rico:** Considere a estima√ß√£o da correla√ß√£o entre dois ativos, A e B, utilizando uma m√©dia m√≥vel com uma janela de 20 dias. Se a soma dos produtos dos retornos di√°rios (retornos do Ativo A multiplicados pelos retornos do Ativo B) dentro da janela de 20 dias for 0.005, a covari√¢ncia seria 0.005/20 = 0.00025. Se o desvio padr√£o dos retornos do Ativo A for 0.01 e o desvio padr√£o dos retornos do Ativo B for 0.015, a correla√ß√£o seria 0.00025 / (0.01 * 0.015) = 1.6667. Este resultado est√° fora do intervalo [-1,1], indicando a necessidade de verificar os c√°lculos e os dados de entrada. Uma correla√ß√£o fora do intervalo v√°lido pode ser causada por erros nos dados, erros nos c√°lculos ou at√© mesmo por uma janela de tempo inadequada.

**Observa√ß√£o 1:** √â importante notar que a correla√ß√£o $\rho_{ij,t}$ deve estar sempre entre -1 e 1. Valores fora deste intervalo indicam um erro no c√°lculo ou na entrada de dados, como demonstrado no exemplo num√©rico acima.

#### Vantagens da Abordagem de M√©dias M√≥veis
A principal vantagem desta abordagem √© a sua simplicidade e facilidade de implementa√ß√£o [^15]. O m√©todo MA √© intuitivo e n√£o requer suposi√ß√µes complexas sobre a distribui√ß√£o dos retornos [^15]. Ele tamb√©m pode capturar algumas mudan√ßas b√°sicas nas correla√ß√µes ao longo do tempo, dependendo do comprimento da janela m√≥vel [^15].

> üí° **Exemplo Num√©rico:** Considere um portf√≥lio com dois ativos, A e B, que s√£o influenciados por um fator comum de mercado (como o S&P 500). Se o modelo de retornos √©:
>
> $$r_A = \beta_A r_{SP} + \epsilon_A$$
> $$r_B = \beta_B r_{SP} + \epsilon_B$$
>
> Onde $r_{SP}$ s√£o os retornos do S&P 500, $\beta_A$ e $\beta_B$ s√£o as sensibilidades dos ativos ao S&P 500, e $\epsilon_A$ e $\epsilon_B$ s√£o os termos de erro espec√≠ficos do ativo. Se $\beta_A$ e $\beta_B$ s√£o ambos positivos, ent√£o os ativos A e B provavelmente ter√£o uma correla√ß√£o positiva.
>
> O risco do portf√≥lio $Var(r_p)$ √©:
> $w_A^2 \sigma_A^2 + w_B^2 \sigma_B^2 + 2w_Aw_B\sigma_A\sigma_B\rho_{AB}$
> Reduzir o valor da covari√¢ncia (atrav√©s da modelagem de $\rho_{AB}$) reduzir√° a varia√ß√£o total do portf√≥lio. O gestor de portf√≥lio pode ajustar a aloca√ß√£o dos ativos $A$ e $B$ (i.e., $w_A$ e $w_B$) para atingir um n√≠vel de risco desejado.

**Proposi√ß√£o 1:** A escolha do tamanho da janela $M$ afeta diretamente a sensibilidade da estimativa da correla√ß√£o a mudan√ßas no mercado. Uma janela menor torna a estimativa mais sens√≠vel a flutua√ß√µes recentes, enquanto uma janela maior suaviza as flutua√ß√µes e fornece uma estimativa mais est√°vel.

**Corol√°rio 1:** A sele√ß√£o do tamanho ideal da janela $M$ depende do objetivo da an√°lise. Para negocia√ß√µes de curto prazo, uma janela menor pode ser prefer√≠vel, enquanto para aloca√ß√µes de ativos de longo prazo, uma janela maior pode ser mais apropriada.

#### Desvantagens da Abordagem de M√©dias M√≥veis
Apesar de sua simplicidade, a abordagem de m√©dias m√≥veis tem v√°rias desvantagens que limitam sua efic√°cia na modelagem de correla√ß√µes em mercados financeiros din√¢micos [^15]:

1.  **Peso Igual para Todas as Observa√ß√µes:** As m√©dias m√≥veis atribuem o mesmo peso a todas as observa√ß√µes dentro da janela, independentemente de sua antiguidade [^15]. Isso ignora o fato de que as informa√ß√µes mais recentes podem ser mais relevantes para prever correla√ß√µes futuras do que as informa√ß√µes mais antigas [^15].

> üí° **Exemplo Num√©rico:** Durante um per√≠odo de mudan√ßas econ√¥micas r√°pidas, como uma crise financeira ou uma mudan√ßa na pol√≠tica monet√°ria, as correla√ß√µes entre os ativos podem mudar rapidamente. Uma m√©dia m√≥vel com uma janela de 60 dias atribuir√° o mesmo peso aos dados de 60 dias atr√°s que aos dados de ontem, mesmo que as condi√ß√µes de mercado tenham mudado drasticamente. Isso pode levar a estimativas de correla√ß√£o desatualizadas e imprecisas. Suponha que dois ativos, ouro e a√ß√µes de tecnologia, historicamente tiveram uma correla√ß√£o baixa. No entanto, devido a mudan√ßas na pol√≠tica monet√°ria que afetam os rendimentos dos t√≠tulos e o apetite ao risco, sua correla√ß√£o se torna positiva e forte (+0.8) nos √∫ltimos 10 dias. Uma m√©dia m√≥vel de 60 dias ainda estaria diluindo este aumento recente na correla√ß√£o com os 50 dias anteriores de baixa correla√ß√£o, resultando numa estimativa de correla√ß√£o muito menor (ex: +0.2), que n√£o reflete a rela√ß√£o atual entre os dois ativos. Isso poderia levar a uma aloca√ß√£o de portf√≥lio inadequada.

2.  **Descontinuidade na Janela M√≥vel:** Quando uma observa√ß√£o sai da janela m√≥vel e uma nova observa√ß√£o entra, isso pode causar mudan√ßas abruptas na estimativa da correla√ß√£o, mesmo que n√£o tenha havido mudan√ßas significativas nas condi√ß√µes de mercado [^15].

> üí° **Exemplo Num√©rico:** Suponha que estejamos estimando a correla√ß√£o entre dois ativos usando uma m√©dia m√≥vel com uma janela de 20 dias. Se a correla√ß√£o hist√≥rica entre esses ativos tiver sido consistentemente baixa, mas no vig√©simo dia anterior, houve um aumento significativo na correla√ß√£o devido a um evento de mercado espec√≠fico, remover essa observa√ß√£o da janela far√° com que a correla√ß√£o estimada caia abruptamente, mesmo que as condi√ß√µes de mercado atuais sugiram que a correla√ß√£o deva ser mais alta. Imagine dois ativos, A e B. Durante 19 dias, a correla√ß√£o √© consistentemente 0.1. No 20¬∫ dia anterior √† data atual, a correla√ß√£o era 0.9 devido a um evento isolado. No dia seguinte, quando calculamos a m√©dia m√≥vel, removemos o dado do 20¬∫ dia, causando uma queda brusca na correla√ß√£o estimada, mesmo que as condi√ß√µes de mercado subjacentes n√£o tenham mudado significativamente. Por exemplo, se os retornos dos ativos A e B (em %) nos √∫ltimos 20 dias foram:
>
> Dias 1-19: A=[0.1, -0.2, 0.3, -0.1, 0.2, \ldots, 0.1], B=[0.05, -0.1, 0.15, -0.05, 0.1, \ldots, 0.05] (baixa correla√ß√£o)
> Dia 20 (h√° 20 dias): A=5, B=4 (alta correla√ß√£o devido a um evento espec√≠fico)
>
> Sem o 20¬∫ dia, a correla√ß√£o √© 0.1. Com o 20¬∫ dia, a correla√ß√£o pode aumentar para 0.3. Remover o 20¬∫ dia causa uma queda repentina na correla√ß√£o.

3.  **Ignora a Ordena√ß√£o Din√¢mica:** A t√©cnica ignora a ordena√ß√£o din√¢mica das observa√ß√µes [^15]. As informa√ß√µes recentes recebem o mesmo peso que as observa√ß√µes mais antigas na janela que pode n√£o ser mais relevante [^15].
    
> üí° **Exemplo Num√©rico:** Imagine que um grande evento de mercado causou forte correla√ß√£o em um curto per√≠odo. A m√©dia m√≥vel trata esses dados hist√≥ricos como estaticamente relevantes, apesar da mudan√ßa nas condi√ß√µes do mercado [^15]. Por exemplo, se uma nova legisla√ß√£o causa uma forte correla√ß√£o entre a√ß√µes de energia renov√°vel e t√≠tulos verdes durante um m√™s, e depois a legisla√ß√£o √© revogada, a m√©dia m√≥vel continuar√° a dar o mesmo peso a este per√≠odo de alta correla√ß√£o, mesmo que ele n√£o seja mais relevante.

4.  **Efeitos Severos ao Descartar Observa√ß√µes:** O descarte de observa√ß√µes da janela m√≥vel pode ter efeitos severos na correla√ß√£o medida [^15].

5.  **Inabilidade de Capturar Mudan√ßas Complexas:** √â incapaz de capturar altera√ß√µes nas correla√ß√µes impulsionadas por mudan√ßas macroecon√¥micas ou outros fatores que podem n√£o ser capturados nos dados de retorno usados no c√°lculo [^18].

**Teorema 1:** A precis√£o da estimativa da correla√ß√£o utilizando m√©dias m√≥veis √© inversamente proporcional √† volatilidade do mercado. Em per√≠odos de alta volatilidade, a m√©dia m√≥vel pode n√£o conseguir capturar as mudan√ßas r√°pidas nas correla√ß√µes, resultando em estimativas imprecisas.

*Prova (Esbo√ßo):* A m√©dia m√≥vel suaviza as flutua√ß√µes nos dados, o que √© ben√©fico em mercados est√°veis, mas prejudicial em mercados vol√°teis. A volatilidade elevada leva a mudan√ßas r√°pidas nas correla√ß√µes, que a m√©dia m√≥vel n√£o consegue acompanhar devido √† sua natureza de pondera√ß√£o igual.

*Prova Detalhada:*

I. Seja $\rho_{ij,t}$ a correla√ß√£o verdadeira entre os ativos $i$ e $j$ no tempo $t$, e $\hat{\rho}_{ij,t}$ a correla√ß√£o estimada usando a m√©dia m√≥vel.

II. O erro de estima√ß√£o pode ser definido como $e_t = \rho_{ij,t} - \hat{\rho}_{ij,t}$. O objetivo √© mostrar que a magnitude de $e_t$ aumenta com a volatilidade do mercado.

III. A volatilidade do mercado pode ser representada por $\sigma_t$, que √© uma medida da dispers√£o dos retornos. Em per√≠odos de alta volatilidade, $\sigma_t$ √© alta.

IV. A estimativa da correla√ß√£o usando a m√©dia m√≥vel √© dada por:
    $$\hat{\rho}_{ij,t} = \frac{\hat{\sigma}_{ij,t}^2}{\sqrt{\hat{\sigma}_{ii,t}^2 \hat{\sigma}_{jj,t}^2}}$$
    Onde $\hat{\sigma}_{ij,t}^2$, $\hat{\sigma}_{ii,t}^2$, e $\hat{\sigma}_{jj,t}^2$ s√£o as estimativas da covari√¢ncia e vari√¢ncias usando a m√©dia m√≥vel.

V. A m√©dia m√≥vel suaviza os dados, o que significa que ela n√£o responde rapidamente √†s mudan√ßas nas correla√ß√µes. Em per√≠odos de alta volatilidade, as correla√ß√µes podem mudar rapidamente, mas a m√©dia m√≥vel n√£o consegue acompanhar essas mudan√ßas.

VI. Portanto, o erro de estima√ß√£o $e_t$ ser√° maior em per√≠odos de alta volatilidade. Matematicamente, isso pode ser representado como:
    $$|e_t| = |\rho_{ij,t} - \hat{\rho}_{ij,t}| \propto \sigma_t$$
    Onde $\propto$ significa "√© proporcional a".

VII. Conclu√≠mos que a precis√£o da estimativa da correla√ß√£o utilizando m√©dias m√≥veis √© inversamente proporcional √† volatilidade do mercado. $\blacksquare$

#### Exemplos da Vida Real

1.  **Crise Financeira de 2008:** Durante a crise financeira de 2008, as correla√ß√µes entre muitos ativos financeiros aumentaram drasticamente, √† medida que os mercados se tornaram mais interconectados e o risco sist√™mico aumentou [^18]. Uma m√©dia m√≥vel com uma janela mais longa n√£o teria capturado totalmente esse aumento repentino nas correla√ß√µes, levando a uma subestima√ß√£o do risco do portf√≥lio [^18].

> üí° **Exemplo Num√©rico:** Suponha que um gestor de fundos use uma m√©dia m√≥vel de 12 meses para estimar a correla√ß√£o entre a√ß√µes e t√≠tulos. Antes da crise de 2008, a correla√ß√£o era baixa (ex: 0.2). Durante a crise, a correla√ß√£o aumentou rapidamente para 0.8, pois ambos os ativos ca√≠ram simultaneamente. A m√©dia m√≥vel, no entanto, demoraria para refletir esse aumento, pois os dados dos meses anteriores (com baixa correla√ß√£o) ainda teriam um peso significativo no c√°lculo. Isso poderia levar o gestor a subestimar o risco do portf√≥lio e a n√£o reduzir a exposi√ß√£o a ativos de risco suficientemente cedo.

2.  **Choques Econ√¥micos:** Se uma m√©dia m√≥vel √© usada para calcular a correla√ß√£o entre commodities como petr√≥leo e g√°s natural, uma mudan√ßa repentina nas pol√≠ticas comerciais globais poderia afetar drasticamente sua correla√ß√£o. Uma m√©dia m√≥vel responderia lentamente, suavizando as flutua√ß√µes que podem ter implica√ß√µes significativas.

> üí° **Exemplo Num√©rico:** Considere um cen√°rio onde o governo imp√µe tarifas significativas sobre importa√ß√µes de petr√≥leo, mas n√£o sobre g√°s natural. Isso poderia levar a um aumento no pre√ßo do petr√≥leo em rela√ß√£o ao g√°s natural, mudando a correla√ß√£o entre os dois. A m√©dia m√≥vel, usando dados hist√≥ricos pr√©-tarifa, n√£o capturaria essa mudan√ßa imediatamente, levando a decis√µes de investimento potencialmente ruins. Se a correla√ß√£o hist√≥rica fosse 0.7 e ca√≠sse repentinamente para 0.2, a m√©dia m√≥vel suavizaria essa queda, atrasando a resposta do investidor √† nova realidade do mercado.

### Alternativas aos Modelos de M√©dias M√≥veis
As limita√ß√µes dos modelos de m√©dias m√≥veis apontam para a necessidade de abordagens mais sofisticadas para modelar correla√ß√µes. Modelos que ponderam as observa√ß√µes de forma diferenciada, como os modelos exponenciais de pondera√ß√£o, podem oferecer melhor desempenho em mercados din√¢micos [^17]. Al√©m disso, modelos que incorporam informa√ß√µes adicionais, como volatilidade impl√≠cita de op√ß√µes ou vari√°veis macroecon√¥micas, tamb√©m podem melhorar a precis√£o das estimativas de correla√ß√£o [^18].

> üí° **Exemplo Num√©rico:** Comparando uma M√©dia M√≥vel simples (SMA) com uma m√©dia m√≥vel ponderada exponencialmente (EWMA) para estimar a correla√ß√£o entre duas a√ß√µes.
>
> *   **Dados:** Retornos di√°rios de duas a√ß√µes (A e B) por 30 dias.
> *   **SMA:** Janela de 20 dias, peso igual para cada observa√ß√£o.
> *   **EWMA:** Fator de decaimento (Œª) de 0.94 (comum em RiskMetrics).
>
> ```python
> import numpy as np
> import pandas as pd
>
> # Retornos di√°rios simulados
> np.random.seed(42)
> returns_a = np.random.normal(0.001, 0.01, 30)
> returns_b = np.random.normal(0.0005, 0.015, 30)
>
> df = pd.DataFrame({'A': returns_a, 'B': returns_b})
>
> # SMA function
> def sma_corr(df, window):
>     return df['A'].rolling(window=window).corr(df['B'])
>
> # EWMA function
> def ewma_corr(df, lambda_):
>     covariances = df.ewm(alpha=1 - lambda_).cov()
>     std_a = np.sqrt(covariances.loc[(slice(None), 'A'), (slice(None), 'A')].values[1::2])
>     std_b = np.sqrt(covariances.loc[(slice(None), 'B'), (slice(None), 'B')].values[1::2])
>     covariance = covariances.loc[(slice(None), 'A'), (slice(None), 'B')].values[1::2]
>     correlation = covariance / (std_a * std_b)
>     return pd.Series(correlation, index=df.index[1:])
>
> window = 20
> lambda_ = 0.94
>
> sma_correlations = sma_corr(df, window)
> ewma_correlations = ewma_corr(df, lambda_)
>
> print("SMA Correlations (last 5 values):\n", sma_correlations.tail())
> print("\nEWMA Correlations (last 5 values):\n", ewma_correlations.tail())
> ```
>
> **Interpreta√ß√£o:** Os valores da EWMA reagem mais rapidamente √†s mudan√ßas nos retornos mais recentes, enquanto os valores da SMA s√£o mais suavizados devido √† pondera√ß√£o igual. Se houver um choque repentino no mercado no dia 25, a EWMA refletir√° essa mudan√ßa de forma mais acentuada na correla√ß√£o do que a SMA.

**Teorema 2:** Modelos de pondera√ß√£o exponencial, como o EWMA (Exponentially Weighted Moving Average), geralmente superam as m√©dias m√≥veis simples na estimativa de correla√ß√µes em mercados financeiros, pois d√£o maior peso √†s observa√ß√µes mais recentes.

*Prova (Esbo√ßo):* Os modelos EWMA atribuem pesos que diminuem exponencialmente com o tempo, permitindo que o modelo se adapte mais rapidamente √†s mudan√ßas nas condi√ß√µes do mercado. Isso resulta em estimativas de correla√ß√£o mais precisas, especialmente em per√≠odos de alta volatilidade ou mudan√ßas r√°pidas no mercado.

*Prova Detalhada:*

I. Seja $\rho_{t}$ a correla√ß√£o verdadeira no tempo $t$, $\hat{\rho}_{t}^{MA}$ a correla√ß√£o estimada pela m√©dia m√≥vel, e $\hat{\rho}_{t}^{EWMA}$ a correla√ß√£o estimada pelo EWMA.

II. O modelo EWMA atribui pesos exponencialmente decrescentes aos retornos hist√≥ricos:
    $$\hat{\sigma}_{ij,t}^2 = \lambda \hat{\sigma}_{ij,t-1}^2 + (1-\lambda)r_{i,t-1}r_{j,t-1}$$
    onde $\lambda$ √© o fator de decaimento, e $0 < \lambda < 1$.

III. A m√©dia m√≥vel atribui pesos iguais a todas as observa√ß√µes dentro da janela $M$:
    $$\hat{\sigma}_{ij,t}^2 = \frac{1}{M} \sum_{k=1}^{M} r_{i,t-k} r_{j,t-k}$$

IV. Considere uma mudan√ßa repentina na correla√ß√£o verdadeira no tempo $t^*$. O EWMA reagir√° mais rapidamente a essa mudan√ßa porque d√° mais peso √†s observa√ß√µes recentes.

V. O erro de estima√ß√£o para a m√©dia m√≥vel √©:
    $$e_t^{MA} = \rho_t - \hat{\rho}_t^{MA}$$
    E para o EWMA √©:
    $$e_t^{EWMA} = \rho_t - \hat{\rho}_t^{EWMA}$$

VI. Devido √† pondera√ß√£o exponencial, $|e_t^{EWMA}| < |e_t^{MA}|$ para $t > t^*$, indicando que o EWMA tem um erro menor ap√≥s uma mudan√ßa na correla√ß√£o verdadeira.

VII. Portanto, os modelos de pondera√ß√£o exponencial geralmente superam as m√©dias m√≥veis simples na estimativa de correla√ß√µes em mercados financeiros. $\blacksquare$

### Conclus√£o

Embora a abordagem de m√©dias m√≥veis seja um m√©todo simples e intuitivo para estimar correla√ß√µes, suas limita√ß√µes na captura da din√¢mica e na pondera√ß√£o de observa√ß√µes a tornam menos adequada para a gest√£o de risco sofisticada e an√°lise de portf√≥lio em mercados financeiros din√¢micos [^15]. Alternativas mais complexas s√£o prefer√≠veis para capturar com mais precis√£o o risco.

### Refer√™ncias
[^1]: Cap√≠tulo 4 mencionado descreve o risco de vari√°veis financeiras b√°sicas, como taxas de juros, taxas de c√¢mbio e pre√ßos de a√ß√µes.
[^15]: The first method is based on moving averages (MAs), using a fixed window of length M.
[^17]: Here shines the simplicity of the RiskMetrics approach.
[^18]: Low correlations help to reduce portfolio risk.
<!-- END -->